<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#F5F0E8">
<title>æ–°æ´¥åº—ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æ¥­å‹™</title>
<style>
/* ========================================
   ãƒªã‚»ãƒƒãƒˆãƒ»åŸºæœ¬è¨­å®š
======================================== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
font-family: -apple-system, BlinkMacSystemFont, â€˜Helvetica Neueâ€™, sans-serif;
background: #FAF9F6;
min-height: 100vh;
color: #1a1a1a;
line-height: 1.6;
padding-bottom: env(safe-area-inset-bottom);
}

/* ========================================
ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
======================================== */
.container {
max-width: 600px;
margin: 0 auto;
padding: 0 20px 120px;
}

header {
padding: 48px 20px 24px;
text-align: center;
}

header h1 {
font-size: 1.75rem;
font-weight: 600;
background: linear-gradient(135deg, #B8860B 0%, #DAA520 50%, #B8860B 100%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
margin-bottom: 4px;
}

.version {
font-size: 0.7rem;
color: #9b9b9b;
letter-spacing: 0.1em;
}

.date-display {
font-size: 0.9rem;
color: #6b6b6b;
margin-top: 4px;
}

/* ========================================
ã‚·ãƒ•ãƒˆé¸æŠç”»é¢
======================================== */
.shift-select-screen {
padding: 40px 0;
}

.shift-buttons {
display: flex;
flex-direction: column;
gap: 12px;
}

.shift-btn {
padding: 20px 24px;
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 12px;
font-size: 1rem;
font-weight: 500;
cursor: pointer;
text-align: left;
display: flex;
justify-content: space-between;
align-items: center;
transition: transform 0.1s, background 0.1s;
}

.shift-btn:active {
transform: scale(0.98);
background: #F5F0E8;
}

.shift-btn .time {
font-size: 0.85rem;
color: #6b6b6b;
font-weight: 400;
}

/* ========================================
ãƒ¡ã‚¤ãƒ³ç”»é¢
======================================== */
.main-screen {
display: none;
}

.main-screen.active {
display: block;
}

.shift-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
padding-bottom: 16px;
border-bottom: 1px solid #E5E2DC;
}

.current-shift {
font-size: 1.2rem;
font-weight: 600;
}

.change-btn {
padding: 8px 16px;
background: transparent;
border: 1px solid #D4CFC5;
border-radius: 8px;
font-size: 0.85rem;
color: #6b6b6b;
cursor: pointer;
}

/* ========================================
ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
======================================== */
.progress-section {
margin-bottom: 24px;
background: #fff;
padding: 15px;
border-radius: 12px;
border: 1px solid #E5E2DC;
}

.progress-bar {
height: 6px;
background: #E8E4DB;
border-radius: 3px;
overflow: hidden;
margin-bottom: 8px;
}

.progress-fill {
height: 100%;
background: linear-gradient(90deg, #B8860B, #DAA520);
transition: width 0.3s ease;
}

.progress-text {
font-size: 0.85rem;
color: #6b6b6b;
text-align: right;
font-weight: 600;
}

/* ========================================
ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
======================================== */
.checklist {
display: flex;
flex-direction: column;
gap: 8px;
}

.checklist-item {
display: flex;
align-items: center;
padding: 16px;
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 10px;
gap: 12px;
transition: background 0.2s, border-color 0.2s;
cursor: pointer;
-webkit-user-select: none;
user-select: none;
}

.checklist-item.checked {
background: #F5F0E8;
border-color: #D4CFC5;
}

.checklist-item .item-text {
flex: 1;
font-size: 0.95rem;
}

.checklist-item.checked .item-text {
color: #8B7355;
text-decoration: line-through;
}

/* ã‚«ã‚¹ã‚¿ãƒ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
.custom-checkbox {
position: relative;
width: 24px;
height: 24px;
flex-shrink: 0;
}

.custom-checkbox input {
position: absolute;
opacity: 0;
width: 100%;
height: 100%;
cursor: pointer;
z-index: 2;
margin: 0;
}

.checkmark {
position: absolute;
top: 0;
left: 0;
width: 24px;
height: 24px;
background: #fff;
border: 2px solid #D4CFC5;
border-radius: 6px;
pointer-events: none;
}

.custom-checkbox input:checked + .checkmark {
background: #B8860B;
border-color: #B8860B;
}

.custom-checkbox input:checked + .checkmark::after {
content: â€˜â€™;
position: absolute;
left: 7px;
top: 3px;
width: 6px;
height: 11px;
border: solid white;
border-width: 0 2px 2px 0;
transform: rotate(45deg);
}

/* æ›œæ—¥ãƒãƒƒã‚¸ */
.day-badge {
font-size: 0.75rem;
padding: 2px 8px;
background: #E8E4DB;
color: #6b6b6b;
border-radius: 4px;
margin-left: 8px;
white-space: nowrap;
flex-shrink: 0;
}

/* ========================================
ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ–
======================================== */
.nav-tabs {
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: #fff;
border-top: 1px solid #E5E2DC;
display: flex;
justify-content: space-around;
padding: 12px 0;
z-index: 100;
padding-bottom: calc(12px + env(safe-area-inset-bottom));
}

.tab {
padding: 8px 20px;
background: transparent;
border: none;
font-size: 0.9rem;
color: #9b9b9b;
border-radius: 8px;
cursor: pointer;
}

.tab.active {
background: #F5F0E8;
color: #B8860B;
font-weight: 600;
}

/* ========================================
ãƒ‘ãƒãƒ«
======================================== */
.panel {
display: none;
}

.panel.active {
display: block;
}

/* ========================================
ç·¨é›†ç”»é¢
======================================== */
.edit-shift-tabs {
display: flex;
gap: 8px;
margin-bottom: 20px;
flex-wrap: wrap;
}

.edit-shift-tab {
padding: 8px 16px;
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 8px;
font-size: 0.85rem;
color: #6b6b6b;
cursor: pointer;
}

.edit-shift-tab.active {
background: #B8860B;
color: #fff;
border-color: #B8860B;
}

.add-item-section {
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 12px;
padding: 16px;
margin-bottom: 20px;
}

.add-item-section input[type=â€œtextâ€] {
width: 100%;
padding: 12px;
border: 1px solid #E5E2DC;
border-radius: 8px;
font-size: 16px;
margin-bottom: 12px;
}

.day-select {
display: flex;
flex-wrap: wrap;
gap: 8px;
margin-bottom: 12px;
}

.day-select label {
display: flex;
align-items: center;
gap: 4px;
padding: 6px 12px;
background: #F5F0E8;
border-radius: 6px;
font-size: 0.85rem;
cursor: pointer;
}

.day-select input {
display: none;
}

.day-select input:checked + span {
color: #B8860B;
font-weight: 600;
}

.date-input-row {
display: flex;
align-items: center;
gap: 8px;
margin-bottom: 12px;
font-size: 0.9rem;
color: #6b6b6b;
}

.date-input-row input {
width: 60px;
padding: 8px;
border: 1px solid #E5E2DC;
border-radius: 6px;
font-size: 16px;
}

.add-btn {
width: 100%;
padding: 12px;
background: #B8860B;
color: #fff;
border: none;
border-radius: 8px;
font-size: 0.9rem;
font-weight: 500;
cursor: pointer;
}

/* ç·¨é›†ãƒªã‚¹ãƒˆ */
.edit-list {
list-style: none;
}

.edit-list-item {
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 10px;
padding: 15px;
margin-bottom: 10px;
}

.edit-item-top {
display: flex;
justify-content: space-between;
align-items: flex-start;
gap: 10px;
}

.edit-item-top .item-text {
flex: 1;
font-size: 0.95rem;
word-break: break-word;
}

.edit-item-bottom {
display: flex;
gap: 8px;
margin-top: 12px;
padding-top: 12px;
border-top: 1px solid #eee;
flex-wrap: wrap;
}

.move-group {
display: flex;
gap: 4px;
}

.action-group {
display: flex;
gap: 8px;
margin-left: auto;
}

.move-btn,
.edit-btn {
background: #E8E4DB;
color: #6b6b6b;
border: none;
padding: 8px 12px;
border-radius: 6px;
font-size: 0.8rem;
cursor: pointer;
}

.delete-btn {
color: #C53030;
background: #FEE;
border: none;
padding: 8px 12px;
border-radius: 6px;
font-size: 0.8rem;
cursor: pointer;
}

/* ========================================
å®Œäº†ãƒœã‚¿ãƒ³
======================================== */
.complete-btn {
width: 100%;
padding: 18px;
background: linear-gradient(135deg, #B8860B, #DAA520);
color: #fff;
border: none;
border-radius: 12px;
font-size: 1rem;
font-weight: 600;
margin-top: 20px;
cursor: pointer;
transition: transform 0.1s;
}

.complete-btn:disabled {
background: #E8E4DB;
color: #9b9b9b;
cursor: not-allowed;
}

.complete-btn:not(:disabled):active {
transform: scale(0.98);
}

/* ========================================
å®Œäº†æ¸ˆã¿è¡¨ç¤º
======================================== */
.already-completed {
background: #E6F4EA;
padding: 20px;
border-radius: 10px;
text-align: center;
margin-bottom: 15px;
}

.undo-btn {
margin-top: 12px;
font-size: 0.85rem;
background: #fff;
border: 1px solid #ccc;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
}

/* ========================================
å±¥æ­´ç”»é¢
======================================== */
.history-item {
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 10px;
padding: 15px;
margin-bottom: 10px;
}

.history-date {
font-weight: 600;
margin-bottom: 4px;
}

.history-shift {
font-size: 0.85rem;
color: #6b6b6b;
margin-bottom: 8px;
}

.history-status {
display: flex;
align-items: center;
gap: 10px;
}

.badge {
padding: 4px 10px;
border-radius: 4px;
font-size: 0.8rem;
font-weight: 500;
}

.badge.complete {
background: #D4EDDA;
color: #155724;
}

.badge.incomplete {
background: #FFF3CD;
color: #856404;
}

.history-meta {
font-size: 0.8rem;
color: #9b9b9b;
}

.history-details {
margin-top: 10px;
}

.history-details summary {
font-size: 0.85rem;
color: #6b6b6b;
cursor: pointer;
}

.history-details ul {
margin-top: 8px;
padding-left: 20px;
}

.history-details li {
font-size: 0.85rem;
color: #6b6b6b;
margin-bottom: 2px;
}

.history-details li.checked {
color: #155724;
}

.no-history {
text-align: center;
color: #9b9b9b;
padding: 40px 0;
}

/* ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.backup-section {
background: #F5F0E8;
border: 1px solid #E5E2DC;
border-radius: 10px;
padding: 16px;
margin-top: 20px;
}

.backup-section h4 {
font-size: 0.9rem;
margin-bottom: 12px;
}

.backup-buttons {
display: flex;
flex-direction: column;
gap: 8px;
}

.backup-btn,
.restore-btn {
padding: 12px;
border: 1px solid #D4CFC5;
border-radius: 8px;
font-size: 0.85rem;
cursor: pointer;
text-align: center;
}

.backup-btn {
background: #fff;
}

.restore-btn {
background: #E8E4DB;
}

.reset-btn {
width: 100%;
padding: 14px;
background: transparent;
color: #C53030;
border: 1px solid #FCC;
border-radius: 8px;
font-size: 0.9rem;
cursor: pointer;
margin-top: 20px;
}

/* ========================================
ãƒ¢ãƒ¼ãƒ€ãƒ«
======================================== */
.modal-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.5);
z-index: 200;
align-items: center;
justify-content: center;
padding: 20px;
}

.modal-overlay.show {
display: flex;
}

.modal {
background: #fff;
border-radius: 16px;
padding: 24px;
width: 100%;
max-width: 400px;
}

.modal h3 {
margin-bottom: 16px;
}

.modal input[type=â€œtextâ€] {
width: 100%;
padding: 12px;
border: 1px solid #E5E2DC;
border-radius: 8px;
font-size: 16px;
margin-bottom: 12px;
}

.modal-buttons {
display: flex;
gap: 12px;
margin-top: 16px;
}

.modal-cancel,
.modal-confirm {
flex: 1;
padding: 12px;
border-radius: 8px;
font-size: 0.9rem;
font-weight: 500;
cursor: pointer;
border: none;
}

.modal-cancel {
background: #E8E4DB;
color: #6b6b6b;
}

.modal-confirm {
background: #B8860B;
color: #fff;
}

/* ========================================
å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
======================================== */
.completion-message {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: #FAF9F6;
z-index: 300;
justify-content: center;
align-items: center;
flex-direction: column;
}

.completion-message.show {
display: flex;
animation: fadeIn 0.3s;
}

.completion-message .icon {
font-size: 64px;
color: #B8860B;
margin-bottom: 20px;
}

.completion-message h2 {
margin-bottom: 8px;
}

.completion-message p {
color: #6b6b6b;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}
</style>

</head>
<body>

<header>
  <h1>æ–°æ´¥åº—ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æ¥­å‹™</h1>
  <div class="version">ver 2026.01.26.2</div>
  <div class="date-display" id="dateDisplay"></div>
</header>

<div class="container">
  <!-- ã‚·ãƒ•ãƒˆé¸æŠç”»é¢ -->
  <div id="shiftSelectScreen" class="shift-select-screen">
    <h2 style="text-align:center; margin-bottom:24px; font-size:1.1rem;">ã‚·ãƒ•ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
    <div class="shift-buttons">
      <button class="shift-btn" data-shift="è¶…æ—©"><span>è¶…æ—©</span><span class="time">7:00 - 16:00</span></button>
      <button class="shift-btn" data-shift="æ—©ç•ª"><span>æ—©ç•ª</span><span class="time">9:00 - 18:00</span></button>
      <button class="shift-btn" data-shift="ä¸­ç•ª"><span>ä¸­ç•ª</span><span class="time">11:00 - 20:00</span></button>
      <button class="shift-btn" data-shift="é…ç•ª"><span>é…ç•ª</span><span class="time">14:30 - 23:30</span></button>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->

  <div id="mainScreen" class="main-screen">
    <div class="nav-tabs">
      <button class="tab active" data-tab="check">ãƒã‚§ãƒƒã‚¯</button>
      <button class="tab" data-tab="edit">é …ç›®ç·¨é›†</button>
      <button class="tab" data-tab="history">å±¥æ­´</button>
    </div>

```
<!-- ãƒã‚§ãƒƒã‚¯ãƒ‘ãƒãƒ« -->
<div id="checkPanel" class="panel active">
  <div class="shift-header">
    <span class="current-shift" id="currentShiftName"></span>
    <button class="change-btn" id="changeShiftBtn">å¤‰æ›´</button>
  </div>
  <div id="alreadyCompleted" class="already-completed" style="display:none;">
    âœ“ æœ¬æ—¥ã®æ¥­å‹™ã¯å®Œäº†ã—ã¦ã„ã¾ã™<br>
    <span style="font-size:0.85rem; color:#666;">æ˜æ—¥ã«ãªã‚‹ã¨ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</span>
    <br>
    <button class="undo-btn" id="undoCompleteBtn">ä¿®æ­£ã™ã‚‹</button>
  </div>
  <div class="progress-section" id="progressSection">
    <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>
    <div id="progressText" class="progress-text">0/0</div>
  </div>
  <div id="checklist" class="checklist"></div>
  <button id="completeBtn" class="complete-btn" disabled>å®Œäº†</button>
</div>

<!-- ç·¨é›†ãƒ‘ãƒãƒ« -->
<div id="editPanel" class="panel">
  <div id="editShiftTabs" class="edit-shift-tabs"></div>
  <div class="add-item-section">
    <input type="text" id="newItemText" placeholder="æ–°ã—ã„é …ç›®ã‚’å…¥åŠ›...">
    <div class="day-select" id="newItemDays">
      <label><input type="checkbox" value="æ¯æ—¥" checked><span>æ¯æ—¥</span></label>
      <label><input type="checkbox" value="æœˆ"><span>æœˆ</span></label>
      <label><input type="checkbox" value="ç«"><span>ç«</span></label>
      <label><input type="checkbox" value="æ°´"><span>æ°´</span></label>
      <label><input type="checkbox" value="æœ¨"><span>æœ¨</span></label>
      <label><input type="checkbox" value="é‡‘"><span>é‡‘</span></label>
      <label><input type="checkbox" value="åœŸ"><span>åœŸ</span></label>
      <label><input type="checkbox" value="æ—¥"><span>æ—¥</span></label>
    </div>
    <div class="date-input-row">
      <span>ç‰¹å®šæ—¥ï¼ˆæ¯æœˆï¼‰:</span>
      <input type="number" id="newItemDate" min="1" max="31" placeholder="-">
      <span>æ—¥</span>
    </div>
    <button class="add-btn" id="addItemBtn">è¿½åŠ </button>
  </div>
  <h3 style="margin-bottom:12px; font-size:1rem;">é …ç›®ä¸€è¦§</h3>
  <ul id="editList" class="edit-list"></ul>
</div>

<!-- å±¥æ­´ãƒ‘ãƒãƒ« -->
<div id="historyPanel" class="panel">
  <div id="historyList"></div>
  <div class="backup-section">
    <h4>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ</h4>
    <div class="backup-buttons">
      <button class="backup-btn" id="exportBackupBtn" onclick="window.exportBackup()">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="restore-btn" id="showRestoreBtn" onclick="window.showRestoreModal()">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</button>
    </div>
  </div>
  <button class="reset-btn" id="resetHistoryBtn" onclick="window.resetHistory()">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
</div>
```

  </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->

<div id="editModal" class="modal-overlay">
  <div class="modal">
    <h3>é …ç›®ã‚’ç·¨é›†</h3>
    <input type="text" id="editItemInput">
    <div class="day-select" id="editItemDays"></div>
    <div class="date-input-row">
      <span>ç‰¹å®šæ—¥:</span>
      <input type="number" id="editItemDate" min="1" max="31" placeholder="-">
      <span>æ—¥</span>
    </div>
    <div class="modal-buttons">
      <button class="modal-cancel" id="editModalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-confirm" id="editModalConfirm">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->

<div id="completionMessage" class="completion-message">
  <div class="icon">âœ“</div>
  <h2>å®Œäº†ã—ã¾ã—ãŸ</h2>
  <p>ãŠç–²ã‚Œæ§˜ã§ã—ãŸ</p>
</div>

<script>
/**
 * ========================================
 * æ–°æ´¥åº—ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æ¥­å‹™ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚¢ãƒ—ãƒª
 * ver 2026.01.26.2
 * ========================================
 * 
 * ã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã€‘
 * - items: { ã‚·ãƒ•ãƒˆå: [{ id, text, days, date }, ...], ... }
 * - todayChecks: { "YYYY-M-D_ã‚·ãƒ•ãƒˆå_itemId": true/false, ... }
 * - history: [{ dateKey, date, shift, time, checkedItems: {id: {text, checked}}, allChecked }, ...]
 * - currentShift: "ã‚·ãƒ•ãƒˆå" | null
 * 
 * ã€æ”¹å–„ç‚¹ã€‘
 * 1. å±¥æ­´ã¯IDãƒ™ãƒ¼ã‚¹ã§ä¿å­˜ï¼ˆé …ç›®ã®ä¸¦ã³æ›¿ãˆãƒ»å‰Šé™¤ã«å¼·ã„ï¼‰
 * 2. æ—¥ä»˜åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’é–¢æ•°åŒ–ãƒ»å …ç‰¢åŒ–
 * 3. localStorageå‘¨ã‚Šã‚’å®‰å…¨ã«å‡¦ç†
 * 4. ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®äºŒé‡ã‚¤ãƒ™ãƒ³ãƒˆé˜²æ­¢
 */

(function() {
  'use strict';

  // ========================================
  // å®šæ•°å®šç¾©
  // ========================================
  
  /** ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ */
  var STORAGE_KEYS = {
    items: 'niitsu_routine_items_v3',
    todayChecks: 'niitsu_routine_checks_v3',
    history: 'niitsu_routine_hist_v3',
    currentShift: 'niitsu_routine_shift',
    lastDate: 'niitsu_routine_date'
  };

  /** ã‚·ãƒ•ãƒˆä¸€è¦§ */
  var SHIFTS = ['è¶…æ—©', 'æ—©ç•ª', 'ä¸­ç•ª', 'é…ç•ª'];

  /** æ›œæ—¥åï¼ˆDate.getDay()ã®æˆ»ã‚Šå€¤ã«å¯¾å¿œï¼‰ */
  var DAY_NAMES = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

  /** ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒãƒ¼ã‚¸ãƒ§ãƒ³ */
  var BACKUP_VERSION = '2026.01.26.2';

  // ========================================
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
  // ========================================
  
  var state = {
    items: {},           // ãƒã‚§ãƒƒã‚¯é …ç›®ãƒ‡ãƒ¼ã‚¿
    todayChecks: {},     // ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹
    history: [],         // å®Œäº†å±¥æ­´
    currentShift: null,  // ç¾åœ¨é¸æŠä¸­ã®ã‚·ãƒ•ãƒˆ
    editingShift: null,  // ç·¨é›†ç”»é¢ã§é¸æŠä¸­ã®ã‚·ãƒ•ãƒˆ
    editingIndex: -1     // ç·¨é›†ä¸­ã®é …ç›®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  };

  // ========================================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  // ========================================

  /**
   * ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆ
   * @returns {string} ãƒ©ãƒ³ãƒ€ãƒ ãªIDæ–‡å­—åˆ—
   */
  function generateId() {
    return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
  }

  /**
   * ä»Šæ—¥ã®æ—¥ä»˜ã‚­ãƒ¼ã‚’å–å¾—ï¼ˆYYYY-M-Då½¢å¼ï¼‰
   * @returns {string}
   */
  function getTodayKey() {
    var d = new Date();
    return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
  }

  /**
   * ä»Šæ—¥ã®æ—¥ä»˜ã‚’æ—¥æœ¬èªæ–‡å­—åˆ—ã§å–å¾—
   * @returns {string}
   */
  function getTodayString() {
    return new Date().toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'long'
    });
  }

  /**
   * ä»Šæ—¥ã®æ›œæ—¥åã‚’å–å¾—
   * @returns {string} 'æ—¥'ã€œ'åœŸ'
   */
  function getTodayDayName() {
    return DAY_NAMES[new Date().getDay()];
  }

  /**
   * ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆæ—¥ï¼‰ã‚’å–å¾—
   * @returns {number} 1ã€œ31
   */
  function getTodayDate() {
    return new Date().getDate();
  }

  // ========================================
  // localStorage å®‰å…¨æ“ä½œ
  // ========================================

  /**
   * localStorageã‹ã‚‰å®‰å…¨ã«èª­ã¿è¾¼ã¿
   * @param {string} key ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
   * @param {*} defaultValue ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
   * @returns {*} ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸå€¤ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
   */
  function loadFromStorage(key, defaultValue) {
    try {
      var data = localStorage.getItem(key);
      if (data === null || data === undefined) {
        return defaultValue;
      }
      var parsed = JSON.parse(data);
      // nullã‚„undefinedãŒãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸå ´åˆã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™
      return (parsed !== null && parsed !== undefined) ? parsed : defaultValue;
    } catch (e) {
      console.warn('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', key, e);
      return defaultValue;
    }
  }

  /**
   * localStorageã¸å®‰å…¨ã«ä¿å­˜
   * @param {string} key ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
   * @param {*} value ä¿å­˜ã™ã‚‹å€¤
   * @returns {boolean} æˆåŠŸã—ãŸã‹ã©ã†ã‹
   */
  function saveToStorage(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (e) {
      console.error('localStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', key, e);
      // å®¹é‡ã‚ªãƒ¼ãƒãƒ¼ã®å ´åˆãªã©ã¯ã‚¢ãƒ©ãƒ¼ãƒˆ
      if (e.name === 'QuotaExceededError') {
        alert('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚');
      }
      return false;
    }
  }

  // ========================================
  // æ—¥ä»˜ãƒ»æ›œæ—¥åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
  // ========================================

  /**
   * é …ç›®ãŒä»Šæ—¥è¡¨ç¤ºã•ã‚Œã‚‹ã¹ãã‹ã‚’åˆ¤å®š
   * 
   * ã€å„ªå…ˆé †ä½ã€‘
   * 1. ç‰¹å®šæ—¥ï¼ˆdateï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ â†’ ãã®æ—¥ã®ã¿è¡¨ç¤º
   * 2. æ›œæ—¥ï¼ˆdaysï¼‰ã«ã€Œæ¯æ—¥ã€ãŒå«ã¾ã‚Œã‚‹ â†’ æ¯æ—¥è¡¨ç¤º
   * 3. æ›œæ—¥ï¼ˆdaysï¼‰ã«ä»Šæ—¥ã®æ›œæ—¥ãŒå«ã¾ã‚Œã‚‹ â†’ ãã®æ›œæ—¥ã®ã¿è¡¨ç¤º
   * 4. ä½•ã‚‚è¨­å®šã•ã‚Œã¦ã„ãªã„ â†’ æ¯æ—¥è¡¨ç¤ºï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
   * 
   * @param {Object} item ãƒã‚§ãƒƒã‚¯é …ç›®
   * @param {number|null} item.date ç‰¹å®šæ—¥ï¼ˆ1ã€œ31ï¼‰
   * @param {string[]} item.days æ›œæ—¥é…åˆ—ï¼ˆ'æ¯æ—¥', 'æœˆ'ã€œ'æ—¥'ï¼‰
   * @returns {boolean}
   */
  function shouldShowItem(item) {
    var todayDate = getTodayDate();
    var todayDayName = getTodayDayName();

    // 1. ç‰¹å®šæ—¥ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
    if (item.date !== null && item.date !== undefined && item.date !== '') {
      var targetDate = parseInt(item.date, 10);
      // ç„¡åŠ¹ãªæ—¥ä»˜ï¼ˆNaNã€0ä»¥ä¸‹ã€32ä»¥ä¸Šï¼‰ã¯è¡¨ç¤ºã—ãªã„
      if (isNaN(targetDate) || targetDate < 1 || targetDate > 31) {
        return false;
      }
      // æœˆæœ«å‡¦ç†ï¼šä¾‹ãˆã°31æ—¥è¨­å®šã§ä»ŠæœˆãŒ30æ—¥ã¾ã§ã®å ´åˆã€
      // ä»Šæ—¥ãŒæœˆæœ«ãªã‚‰è¡¨ç¤ºã™ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã¨ã—ã¦å°†æ¥å®Ÿè£…å¯èƒ½ï¼‰
      // ç¾çŠ¶ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å®Œå…¨ä¸€è‡´ã®ã¿
      return targetDate === todayDate;
    }

    // 2. æ›œæ—¥è¨­å®šã®ç¢ºèª
    var days = item.days;
    
    // æ›œæ—¥ãŒæœªè¨­å®šã¾ãŸã¯ç©ºé…åˆ—ã®å ´åˆã¯æ¯æ—¥è¡¨ç¤ºï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
    if (!days || !Array.isArray(days) || days.length === 0) {
      return true;
    }

    // ã€Œæ¯æ—¥ã€ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°è¡¨ç¤º
    if (days.indexOf('æ¯æ—¥') !== -1) {
      return true;
    }

    // ä»Šæ—¥ã®æ›œæ—¥ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°è¡¨ç¤º
    if (days.indexOf(todayDayName) !== -1) {
      return true;
    }

    return false;
  }

  /**
   * é …ç›®ã®è¡¨ç¤ºç”¨ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
   * @param {Object} item
   * @returns {string} è¡¨ç¤ºãƒ©ãƒ™ãƒ«ï¼ˆç©ºæ–‡å­—ã®å ´åˆã‚‚ã‚ã‚Šï¼‰
   */
  function getItemDayLabel(item) {
    if (item.date) {
      return item.date + 'æ—¥';
    }
    if (item.days && item.days.length > 0 && item.days.indexOf('æ¯æ—¥') === -1) {
      return item.days.join('ãƒ»');
    }
    return '';
  }

  // ========================================
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿
  // ========================================

  /**
   * åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
   * @returns {Object}
   */
  function createDefaultItems() {
    return {
      'è¶…æ—©': [
        { id: generateId(), text: 'ç¤¾å“¡â‘ ï¼—:00æœç¤¼', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘ å£²å¤‰ï¼ˆå‰æ—¥å¤œã ãŒå½“æ—¥å‡ºåŠ›ã•ã‚ŒãŸå ´åˆã¯å®Ÿæ–½ï¼‰', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘ å–ã‚Šå¯„ã›ç™ºæ³¨', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘ ãƒã‚¹ãƒˆç¢ºèª', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘ æ¬ å“ãƒªã‚¹ãƒˆå°åˆ·', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘ é’æœå°å…¥ãƒªã‚¹ãƒˆå°åˆ·', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘¡8:30æœç¤¼', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘¡æœ¬éƒ¨ä¾¿å‡¦ç†', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘¡è²©ä¿ƒPOPè²¼ï¼ˆã®ã¼ã‚Šï¼‰', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘¡æ°´æŠœãï¼ˆ6/1-9/30ï¼‰', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘¡å–ã‚Šå¯„ã›ç¢ºèªï¼ˆé£²æ–™ã‚‚ï¼‰', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘¡ï¼‘ä¾¿ã‚’ï¼˜æ™‚ã¾ã§ã«ä¸­ã«å…¥ã‚Œã‚‹', days: ['æ¯æ—¥'], date: null }
      ],
      'æ—©ç•ª': [
        { id: generateId(), text: 'ç¤¾å“¡â‘¢ä»•åˆ†ã‘ï¼ˆé£²æ–™å“å‡ºã—ã®ã‚ã¨ï¼‰', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘¢çŸ¥ä¹…å±‹å£²ä¸Š', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ç¤¾å“¡â‘¢ãƒˆãƒŠãƒ¼ã€ãƒ©ãƒŸç¢ºèªï¼ˆæ—¥æ›œæ—¥ã®ã¿ï¼‰', days: ['æ—¥'], date: null }
      ],
      'ä¸­ç•ª': [],
      'é…ç•ª': [
        { id: generateId(), text: 'éŸ¿ãã‚„FAXï¼ˆæœˆæ›œã®ã¿ï¼‰', days: ['æœˆ'], date: null },
        { id: generateId(), text: 'HACCAPãƒã‚§ãƒƒã‚¯', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ãŠå®¢æ§˜ã®å£°å›å', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'å¤œå£²å¤‰ï¼ˆå€¤ä¸‹ã¯é–‰åº—å¾ŒPOPè¨­ç½®ï¼‰', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€é‡‘åˆ¸ã€‘é‡‘åˆ¸ã€ãƒ¬ã‚¸ãƒã‚¤ãƒ¬ã‚·ãƒ¼ãƒˆå›å', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€é‡‘åˆ¸ã€‘å–ã‚Šå¯„ã›åˆ¸ã€ãƒã‚¤ãƒ³ãƒˆã®ã‚«ãƒ¼ãƒ‰é–¢é€£ã€ipadå›å', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€é‡‘åˆ¸ã€‘ãƒ¬ã‚¸æ—¥å ±ã€é•ç®—é‡‘è¨˜å…¥', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€é‡‘åˆ¸ã€‘æ®‹æ¥­ãƒ¡ãƒ¼ãƒ«ä½œæˆ', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€ç¾é‡‘ã€‘ãƒ¬ã‚¸ä¸¡æ›¿', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€ç¾é‡‘ã€‘é‡‘åº«å†…ç‚¹æ¤œ', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€ç¾é‡‘ã€‘å£²ä¸Šé‡‘å›å', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€ç¾é‡‘ã€‘ã‚¢ãƒ«ã‚½ãƒƒã‚¯ä¸¡æ›¿ï¼ˆæ—¥ã€æœ¨ï¼‰', days: ['æ—¥', 'æœ¨'], date: null },
        { id: generateId(), text: 'ã€ç¢ºèªã€‘HACCAPã€è²©å£²ç®¡ç†è¨˜éŒ²è¨˜å…¥', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€ç¢ºèªã€‘è²©ä¿ƒPOPã¨ã‚Š', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€ç¢ºèªã€‘é’æœæ°´æŠœãï¼ˆå¤ï¼‰', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€ç¢ºèªã€‘èƒ½å‹•å…¥åŠ›', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€ç¢ºèªã€‘æµ·å•†å ±å‘Š', days: ['æ¯æ—¥'], date: null },
        { id: generateId(), text: 'ã€ç¢ºèªã€‘é’æœå®¤ã§HACCAPã‚µã‚¤ãƒ³', days: ['æ¯æ—¥'], date: null }
      ]
    };
  }

  // ========================================
  // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  // ========================================

  /**
   * å¤ã„å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ–°å½¢å¼ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
   * @param {Object} items
   * @returns {Object}
   */
  function migrateItems(items) {
    if (!items || typeof items !== 'object') {
      return createDefaultItems();
    }

    var migrated = {};
    for (var shift in items) {
      if (!Array.isArray(items[shift])) {
        migrated[shift] = [];
        continue;
      }
      migrated[shift] = items[shift].map(function(item) {
        // IDãŒãªã„å ´åˆã¯ç”Ÿæˆ
        if (!item.id) {
          item.id = generateId();
        }
        // daysãŒãªã„å ´åˆã¯ç©ºé…åˆ—
        if (!item.days) {
          item.days = ['æ¯æ—¥'];
        }
        // dateãŒundefinedã®å ´åˆã¯null
        if (item.date === undefined) {
          item.date = null;
        }
        return item;
      });
    }

    // å­˜åœ¨ã—ãªã„ã‚·ãƒ•ãƒˆã¯ç©ºé…åˆ—ã§åˆæœŸåŒ–
    SHIFTS.forEach(function(shift) {
      if (!migrated[shift]) {
        migrated[shift] = [];
      }
    });

    return migrated;
  }

  /**
   * å¤ã„å±¥æ­´å½¢å¼ï¼ˆindexãƒ™ãƒ¼ã‚¹ï¼‰ã‚’æ–°å½¢å¼ï¼ˆIDãƒ™ãƒ¼ã‚¹ï¼‰ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
   * â€»å®Œå…¨ãªå¤‰æ›ã¯ä¸å¯èƒ½ãªãŸã‚ã€å¤ã„å±¥æ­´ã¯è¡¨ç¤ºã®ã¿å¯¾å¿œ
   * @param {Array} history
   * @returns {Array}
   */
  function migrateHistory(history) {
    if (!Array.isArray(history)) {
      return [];
    }
    return history.map(function(record) {
      // ã™ã§ã«æ–°å½¢å¼ï¼ˆcheckedItemsï¼‰ã®å ´åˆã¯ãã®ã¾ã¾
      if (record.checkedItems) {
        return record;
      }
      // æ—§å½¢å¼ï¼ˆitemsé…åˆ— + checks ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã®å ´åˆ
      // å®Œå…¨ãªå¤‰æ›ã¯ä¸å¯èƒ½ã ãŒã€è¡¨ç¤ºç”¨ã«å¤‰æ›
      if (record.items && record.checks) {
        var checkedItems = {};
        record.items.forEach(function(text, index) {
          // ä»®ã®IDã‚’ç”Ÿæˆï¼ˆè¡¨ç¤ºç”¨ï¼‰
          var tempId = 'legacy_' + index;
          checkedItems[tempId] = {
            text: text,
            checked: !!record.checks[index]
          };
        });
        return {
          dateKey: record.dateKey,
          date: record.date,
          shift: record.shift,
          time: record.time,
          checkedItems: checkedItems,
          allChecked: record.allChecked
        };
      }
      return record;
    });
  }

  // ========================================
  // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ç®¡ç†
  // ========================================

  /**
   * ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®ã‚­ãƒ¼ã‚’ç”Ÿæˆ
   * @param {string} shift ã‚·ãƒ•ãƒˆå
   * @param {string} itemId é …ç›®ID
   * @returns {string}
   */
  function getCheckKey(shift, itemId) {
    return getTodayKey() + '_' + shift + '_' + itemId;
  }

  /**
   * é …ç›®ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’å–å¾—
   * @param {string} itemId
   * @returns {boolean}
   */
  function isItemChecked(itemId) {
    var key = getCheckKey(state.currentShift, itemId);
    return !!state.todayChecks[key];
  }

  /**
   * é …ç›®ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«
   * @param {string} itemId
   */
  function toggleItemCheck(itemId) {
    var key = getCheckKey(state.currentShift, itemId);
    state.todayChecks[key] = !state.todayChecks[key];
    saveToStorage(STORAGE_KEYS.todayChecks, state.todayChecks);
    renderChecklist();
    updateProgress();
  }

  /**
   * ç¾åœ¨ã®ã‚·ãƒ•ãƒˆã®è¡¨ç¤ºé …ç›®ã‚’å–å¾—
   * @returns {Array}
   */
  function getVisibleItems() {
    if (!state.currentShift || !state.items[state.currentShift]) {
      return [];
    }
    return state.items[state.currentShift].filter(shouldShowItem);
  }

  /**
   * å®Œäº†å¯èƒ½ã‹ã©ã†ã‹ã‚’åˆ¤å®š
   * @returns {boolean}
   */
  function canComplete() {
    var visible = getVisibleItems();
    if (visible.length === 0) {
      return false;
    }
    return visible.every(function(item) {
      return isItemChecked(item.id);
    });
  }

  // ========================================
  // æ—¥ä»˜å¤‰æ›´æ¤œçŸ¥
  // ========================================

  /**
   * æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯ã—ã€å¿…è¦ãªã‚‰ãƒªã‚»ãƒƒãƒˆ
   * @returns {boolean} æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸå ´åˆtrue
   */
  function checkDateChange() {
    var lastDate = localStorage.getItem(STORAGE_KEYS.lastDate);
    var today = getTodayKey();

    if (lastDate !== today) {
      localStorage.setItem(STORAGE_KEYS.lastDate, today);
      state.todayChecks = {};
      saveToStorage(STORAGE_KEYS.todayChecks, state.todayChecks);
      return true;
    }
    return false;
  }

  // ========================================
  // å®Œäº†å‡¦ç†
  // ========================================

  /**
   * æœ¬æ—¥ã™ã§ã«å®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
   * @returns {boolean}
   */
  function isAlreadyCompleted() {
    var todayKey = getTodayKey();
    return state.history.some(function(record) {
      return record.dateKey === todayKey &&
             record.shift === state.currentShift &&
             record.allChecked === true;
    });
  }

  /**
   * å®Œäº†å‡¦ç†ã‚’å®Ÿè¡Œ
   */
  function completeCheck() {
    if (!canComplete()) {
      return;
    }

    var todayKey = getTodayKey();
    var now = new Date();
    var visible = getVisibleItems();

    // IDãƒ™ãƒ¼ã‚¹ã§ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ä¿å­˜
    var checkedItems = {};
    visible.forEach(function(item) {
      checkedItems[item.id] = {
        text: item.text,
        checked: isItemChecked(item.id)
      };
    });

    var record = {
      dateKey: todayKey,
      date: getTodayString(),
      shift: state.currentShift,
      time: now.getHours() + ':' + ('0' + now.getMinutes()).slice(-2),
      checkedItems: checkedItems,
      allChecked: true
    };

    state.history.unshift(record);
    
    // å±¥æ­´ã¯æœ€å¤§100ä»¶ã¾ã§
    if (state.history.length > 100) {
      state.history = state.history.slice(0, 100);
    }
    
    saveToStorage(STORAGE_KEYS.history, state.history);

    // å®Œäº†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
    showCompletionMessage();
  }

  /**
   * å®Œäº†ã‚’å–ã‚Šæ¶ˆã—
   */
  function undoComplete() {
    var todayKey = getTodayKey();
    state.history = state.history.filter(function(record) {
      return !(record.dateKey === todayKey && record.shift === state.currentShift);
    });
    saveToStorage(STORAGE_KEYS.history, state.history);
    
    renderChecklist();
    updateProgress();
    updateCompletedState();
    renderHistory();
  }

  /**
   * å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
   */
  function showCompletionMessage() {
    var msg = document.getElementById('completionMessage');
    msg.classList.add('show');
    setTimeout(function() {
      msg.classList.remove('show');
      updateCompletedState();
      renderHistory();
    }, 1500);
  }

  // ========================================
  // UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  // ========================================

  /**
   * ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’æç”»
   */
  function renderChecklist() {
    var container = document.getElementById('checklist');
    container.innerHTML = '';

    var visible = getVisibleItems();

    if (visible.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:#9b9b9b; padding:20px;">æœ¬æ—¥ã®ãƒã‚§ãƒƒã‚¯é …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
      return;
    }

    visible.forEach(function(item) {
      var checked = isItemChecked(item.id);
      var dayLabel = getItemDayLabel(item);

      var div = document.createElement('div');
      div.className = 'checklist-item' + (checked ? ' checked' : '');
      div.setAttribute('data-id', item.id);

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹éƒ¨åˆ†
      var checkboxDiv = document.createElement('div');
      checkboxDiv.className = 'custom-checkbox';
      
      var input = document.createElement('input');
      input.type = 'checkbox';
      input.checked = checked;
      input.setAttribute('data-id', item.id);
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¯è¦ªè¦ç´ ã§å‡¦ç†ã™ã‚‹ãŸã‚åœæ­¢
      input.addEventListener('click', function(e) {
        e.stopPropagation();
      });
      input.addEventListener('change', function(e) {
        toggleItemCheck(e.target.getAttribute('data-id'));
      });

      var checkmark = document.createElement('span');
      checkmark.className = 'checkmark';

      checkboxDiv.appendChild(input);
      checkboxDiv.appendChild(checkmark);

      // ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†
      var textSpan = document.createElement('span');
      textSpan.className = 'item-text';
      textSpan.textContent = item.text;

      div.appendChild(checkboxDiv);
      div.appendChild(textSpan);

      // æ›œæ—¥ãƒãƒƒã‚¸
      if (dayLabel) {
        var badge = document.createElement('span');
        badge.className = 'day-badge';
        badge.textContent = dayLabel;
        div.appendChild(badge);
      }

      // è¡Œå…¨ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã§ãƒˆã‚°ãƒ«ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»¥å¤–ã®éƒ¨åˆ†ï¼‰
      div.addEventListener('click', function(e) {
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹éƒ¨åˆ†ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
        if (e.target.tagName === 'INPUT') {
          return;
        }
        var itemId = this.getAttribute('data-id');
        toggleItemCheck(itemId);
      });

      container.appendChild(div);
    });

    updateCompletedState();
  }

  /**
   * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
   */
  function updateProgress() {
    var visible = getVisibleItems();
    var total = visible.length;
    var checked = visible.filter(function(item) {
      return isItemChecked(item.id);
    }).length;

    var percent = total > 0 ? (checked / total) * 100 : 0;

    document.getElementById('progressFill').style.width = percent + '%';
    document.getElementById('progressText').textContent = checked + '/' + total;
    document.getElementById('completeBtn').disabled = !canComplete();
  }

  /**
   * å®Œäº†æ¸ˆã¿çŠ¶æ…‹ã®è¡¨ç¤ºã‚’æ›´æ–°
   */
  function updateCompletedState() {
    var completed = isAlreadyCompleted();
    var alreadyMsg = document.getElementById('alreadyCompleted');
    var checklist = document.getElementById('checklist');
    var progressSection = document.getElementById('progressSection');
    var completeBtn = document.getElementById('completeBtn');

    if (completed) {
      alreadyMsg.style.display = 'block';
      checklist.style.display = 'none';
      progressSection.style.display = 'none';
      completeBtn.style.display = 'none';
    } else {
      alreadyMsg.style.display = 'none';
      checklist.style.display = 'flex';
      progressSection.style.display = 'block';
      completeBtn.style.display = 'block';
    }
  }

  /**
   * ç·¨é›†ç”»é¢ã®ã‚·ãƒ•ãƒˆã‚¿ãƒ–ã‚’æç”»
   */
  function renderEditShiftTabs() {
    var container = document.getElementById('editShiftTabs');
    container.innerHTML = '';

    SHIFTS.forEach(function(shift) {
      var btn = document.createElement('button');
      btn.className = 'edit-shift-tab' + (shift === state.editingShift ? ' active' : '');
      btn.textContent = shift;
      btn.addEventListener('click', function() {
        state.editingShift = shift;
        renderEditShiftTabs();
        renderEditList();
      });
      container.appendChild(btn);
    });
  }

  /**
   * ç·¨é›†ãƒªã‚¹ãƒˆã‚’æç”»
   */
  function renderEditList() {
    var container = document.getElementById('editList');
    container.innerHTML = '';

    if (!state.editingShift || !state.items[state.editingShift]) {
      return;
    }

    var shiftItems = state.items[state.editingShift];

    shiftItems.forEach(function(item, index) {
      var dayLabel = '';
      if (item.date) {
        dayLabel = 'æ¯æœˆ' + item.date + 'æ—¥';
      } else if (item.days && item.days.length > 0) {
        dayLabel = item.days.join('ãƒ»');
      }

      var li = document.createElement('li');
      li.className = 'edit-list-item';

      // ä¸Šéƒ¨ï¼šãƒ†ã‚­ã‚¹ãƒˆã¨ãƒãƒƒã‚¸
      var topDiv = document.createElement('div');
      topDiv.className = 'edit-item-top';
      
      var textSpan = document.createElement('span');
      textSpan.className = 'item-text';
      textSpan.textContent = item.text;
      topDiv.appendChild(textSpan);

      if (dayLabel) {
        var badge = document.createElement('span');
        badge.className = 'day-badge';
        badge.textContent = dayLabel;
        topDiv.appendChild(badge);
      }

      // ä¸‹éƒ¨ï¼šãƒœã‚¿ãƒ³ç¾¤
      var bottomDiv = document.createElement('div');
      bottomDiv.className = 'edit-item-bottom';

      var moveGroup = document.createElement('div');
      moveGroup.className = 'move-group';

      var upBtn = document.createElement('button');
      upBtn.className = 'move-btn';
      upBtn.textContent = 'â†‘ä¸Šã¸';
      upBtn.addEventListener('click', function() { moveItem(index, -1); });

      var downBtn = document.createElement('button');
      downBtn.className = 'move-btn';
      downBtn.textContent = 'â†“ä¸‹ã¸';
      downBtn.addEventListener('click', function() { moveItem(index, 1); });

      moveGroup.appendChild(upBtn);
      moveGroup.appendChild(downBtn);

      var actionGroup = document.createElement('div');
      actionGroup.className = 'action-group';

      var editBtn = document.createElement('button');
      editBtn.className = 'edit-btn';
      editBtn.textContent = 'ç·¨é›†';
      editBtn.addEventListener('click', function() { openEditModal(index); });

      var deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = 'å‰Šé™¤';
      deleteBtn.addEventListener('click', function() { deleteItem(index); });

      actionGroup.appendChild(editBtn);
      actionGroup.appendChild(deleteBtn);

      bottomDiv.appendChild(moveGroup);
      bottomDiv.appendChild(actionGroup);

      li.appendChild(topDiv);
      li.appendChild(bottomDiv);
      container.appendChild(li);
    });
  }

  /**
   * å±¥æ­´ã‚’æç”»
   */
  function renderHistory() {
    var container = document.getElementById('historyList');

    if (state.history.length === 0) {
      container.innerHTML = '<div class="no-history">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    var html = '';
    var displayHistory = state.history.slice(0, 50);

    displayHistory.forEach(function(record) {
      var checkedItems = record.checkedItems || {};
      var ids = Object.keys(checkedItems);
      var totalCount = ids.length;
      var checkedCount = ids.filter(function(id) {
        return checkedItems[id].checked;
      }).length;

      var itemsHtml = ids.map(function(id) {
        var item = checkedItems[id];
        var isChecked = item.checked;
        return '<li class="' + (isChecked ? 'checked' : '') + '">' +
               (isChecked ? 'âœ“ ' : 'âˆ’ ') + item.text + '</li>';
      }).join('');

      html += '<div class="history-item">' +
              '<div class="history-date">' + record.date + '</div>' +
              '<div class="history-shift">' + record.shift + '</div>' +
              '<div class="history-status">' +
              '<span class="badge ' + (record.allChecked ? 'complete' : 'incomplete') + '">' +
              (record.allChecked ? 'å®Œäº†' : 'æœªå®Œäº†') + '</span>' +
              '<span class="history-meta">' + checkedCount + '/' + totalCount + ' â€¢ ' + record.time + '</span>' +
              '</div>' +
              '<details class="history-details">' +
              '<summary>è©³ç´°ã‚’è¡¨ç¤º</summary>' +
              '<ul>' + itemsHtml + '</ul>' +
              '</details>' +
              '</div>';
    });

    container.innerHTML = html;
  }

  // ========================================
  // é …ç›®ç·¨é›†æ©Ÿèƒ½
  // ========================================

  /**
   * é …ç›®ã‚’è¿½åŠ 
   */
  function addItem() {
    var textInput = document.getElementById('newItemText');
    var text = textInput.value.trim();

    if (!text) {
      alert('é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    var days = getSelectedDays('newItemDays');
    var dateValue = document.getElementById('newItemDate').value;
    var date = dateValue ? parseInt(dateValue, 10) : null;

    // ç‰¹å®šæ—¥ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›œæ—¥ã‚’ã‚¯ãƒªã‚¢
    if (date) {
      days = [];
    }

    if (!state.items[state.editingShift]) {
      state.items[state.editingShift] = [];
    }

    state.items[state.editingShift].push({
      id: generateId(),
      text: text,
      days: days,
      date: date
    });

    saveToStorage(STORAGE_KEYS.items, state.items);

    // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
    textInput.value = '';
    document.getElementById('newItemDate').value = '';
    resetDaySelect('newItemDays');

    renderEditList();

    // ç¾åœ¨ã®ã‚·ãƒ•ãƒˆãªã‚‰å†æç”»
    if (state.editingShift === state.currentShift) {
      renderChecklist();
      updateProgress();
    }
  }

  /**
   * é …ç›®ã‚’ç§»å‹•
   * @param {number} index
   * @param {number} direction -1:ä¸Š / 1:ä¸‹
   */
  function moveItem(index, direction) {
    var items = state.items[state.editingShift];
    var newIndex = index + direction;

    if (newIndex < 0 || newIndex >= items.length) {
      return;
    }

    var temp = items[index];
    items[index] = items[newIndex];
    items[newIndex] = temp;

    saveToStorage(STORAGE_KEYS.items, state.items);
    renderEditList();

    if (state.editingShift === state.currentShift) {
      renderChecklist();
    }
  }

  /**
   * é …ç›®ã‚’å‰Šé™¤
   * @param {number} index
   */
  function deleteItem(index) {
    if (!confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }

    state.items[state.editingShift].splice(index, 1);
    saveToStorage(STORAGE_KEYS.items, state.items);
    renderEditList();

    if (state.editingShift === state.currentShift) {
      renderChecklist();
      updateProgress();
    }
  }

  /**
   * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
   * @param {number} index
   */
  function openEditModal(index) {
    state.editingIndex = index;
    var item = state.items[state.editingShift][index];

    document.getElementById('editItemInput').value = item.text;
    document.getElementById('editItemDate').value = item.date || '';

    // æ›œæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
    var daysContainer = document.getElementById('editItemDays');
    var allDays = ['æ¯æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
    daysContainer.innerHTML = '';

    allDays.forEach(function(day) {
      var isChecked = item.days && item.days.indexOf(day) !== -1;
      var label = document.createElement('label');
      var input = document.createElement('input');
      input.type = 'checkbox';
      input.value = day;
      input.checked = isChecked;
      var span = document.createElement('span');
      span.textContent = day;
      label.appendChild(input);
      label.appendChild(span);
      daysContainer.appendChild(label);
    });

    setupDaySelectLogic('editItemDays');
    document.getElementById('editModal').classList.add('show');
  }

  /**
   * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
   */
  function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
    state.editingIndex = -1;
  }

  /**
   * ç·¨é›†ã‚’ç¢ºå®š
   */
  function confirmEdit() {
    var text = document.getElementById('editItemInput').value.trim();

    if (!text) {
      alert('é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    var days = getSelectedDays('editItemDays');
    var dateValue = document.getElementById('editItemDate').value;
    var date = dateValue ? parseInt(dateValue, 10) : null;

    if (date) {
      days = [];
    }

    var item = state.items[state.editingShift][state.editingIndex];
    item.text = text;
    item.days = days;
    item.date = date;

    saveToStorage(STORAGE_KEYS.items, state.items);
    closeEditModal();
    renderEditList();

    if (state.editingShift === state.currentShift) {
      renderChecklist();
      updateProgress();
    }
  }

  // ========================================
  // æ›œæ—¥é¸æŠãƒ˜ãƒ«ãƒ‘ãƒ¼
  // ========================================

  /**
   * é¸æŠã•ã‚ŒãŸæ›œæ—¥ã‚’å–å¾—
   * @param {string} containerId
   * @returns {string[]}
   */
  function getSelectedDays(containerId) {
    var container = document.getElementById(containerId);
    var checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
    var days = [];
    checkboxes.forEach(function(cb) {
      days.push(cb.value);
    });
    return days;
  }

  /**
   * æ›œæ—¥é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
   * @param {string} containerId
   */
  function resetDaySelect(containerId) {
    var container = document.getElementById(containerId);
    var checkboxes = container.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(function(cb) {
      cb.checked = (cb.value === 'æ¯æ—¥');
    });
  }

  /**
   * æ›œæ—¥é¸æŠã®æ’ä»–ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¨­å®š
   * @param {string} containerId
   */
  function setupDaySelectLogic(containerId) {
    var container = document.getElementById(containerId);
    if (!container) return;

    var checkboxes = container.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(function(cb) {
      cb.addEventListener('change', function() {
        if (this.value === 'æ¯æ—¥' && this.checked) {
          // ã€Œæ¯æ—¥ã€ãŒãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‰ä»–ã‚’å¤–ã™
          checkboxes.forEach(function(other) {
            if (other.value !== 'æ¯æ—¥') {
              other.checked = false;
            }
          });
        } else if (this.value !== 'æ¯æ—¥' && this.checked) {
          // ç‰¹å®šæ›œæ—¥ãŒãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‰ã€Œæ¯æ—¥ã€ã‚’å¤–ã™
          var everyday = container.querySelector('input[value="æ¯æ—¥"]');
          if (everyday) {
            everyday.checked = false;
          }
        }
      });
    });
  }

  // ========================================
  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ
  // ========================================

  /**
   * ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
   */
  function exportBackup() {
    var backup = {
      version: BACKUP_VERSION,
      exportDate: new Date().toISOString(),
      items: state.items,
      history: state.history,
      todayChecks: state.todayChecks,
      currentShift: state.currentShift
    };

    var text = JSON.stringify(backup);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    var modal = document.createElement('div');
    modal.id = 'backupModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px;';

    var inner = document.createElement('div');
    inner.style.cssText = 'background:white;border-radius:12px;padding:20px;width:100%;max-height:80%;overflow:auto;';
    inner.innerHTML = 
      '<h3 style="margin-bottom:12px;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿</h3>' +
      '<p style="font-size:0.85rem;color:#666;margin-bottom:12px;">ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é•·æŠ¼ã—â†’ã™ã¹ã¦ã‚’é¸æŠâ†’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãƒ¡ãƒ¢å¸³ã«ä¿å­˜ã—ã¦ãã ã•ã„</p>' +
      '<textarea id="backupTextArea" readonly style="width:100%;height:180px;font-size:11px;padding:8px;border:1px solid #ccc;border-radius:8px;background:#f9f9f9;"></textarea>' +

```
  '<button id="closeBackupBtn" style="width:100%;padding:14px;background:#B8860B;color:white;border:none;border-radius:8px;font-weight:500;margin-top:12px;cursor:pointer;">é–‰ã˜ã‚‹</button>';

modal.appendChild(inner);
document.body.appendChild(modal);

document.getElementById('backupTextArea').value = text;
document.getElementById('closeBackupBtn').addEventListener('click', function() {
  modal.remove();
});
```

}
window.exportBackup = exportBackup;

/**

- å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  */
  function showRestoreModal() {
  var modal = document.createElement(â€˜divâ€™);
  modal.id = â€˜restoreModalâ€™;
  modal.style.cssText = â€˜position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px;â€™;

```
var inner = document.createElement('div');
inner.style.cssText = 'background:white;border-radius:12px;padding:20px;width:100%;';
inner.innerHTML = 
  '<h3 style="margin-bottom:12px;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</h3>' +
  '<p style="font-size:0.85rem;color:#666;margin-bottom:12px;">ãƒ¡ãƒ¢å¸³ã«ä¿å­˜ã—ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</p>' +
  '<textarea id="restoreTextArea" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘" style="width:100%;height:150px;font-size:11px;padding:8px;border:1px solid #ccc;border-radius:8px;"></textarea>' +
  '<div style="display:flex;gap:8px;margin-top:12px;">' +
  '<button id="doRestoreBtn" style="flex:1;padding:14px;background:#B8860B;color:white;border:none;border-radius:8px;font-weight:500;cursor:pointer;">å¾©å…ƒã™ã‚‹</button>' +
  '<button id="cancelRestoreBtn" style="flex:1;padding:14px;background:#E8E4DB;border:none;border-radius:8px;font-weight:500;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>' +
  '</div>';

modal.appendChild(inner);
document.body.appendChild(modal);

document.getElementById('doRestoreBtn').addEventListener('click', function() {
  var text = document.getElementById('restoreTextArea').value.trim();
  if (!text) {
    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
    return;
  }
  restoreBackup(text, modal);
});

document.getElementById('cancelRestoreBtn').addEventListener('click', function() {
  modal.remove();
});
```

}
window.showRestoreModal = showRestoreModal;

/**

- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
- @param {string} text JSONæ–‡å­—åˆ—
- @param {HTMLElement} modal
  */
  function restoreBackup(text, modal) {
  try {
  var backup = JSON.parse(text);
  
  if (!backup.items) {
  alert(â€˜ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã§ã™â€™);
  return;
  }
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
  state.items = migrateItems(backup.items);
  state.history = migrateHistory(backup.history || []);
  state.todayChecks = backup.todayChecks || {};
  
  // currentShiftã¯å¾©å…ƒã—ãªã„ï¼ˆç¾åœ¨ã®ç”»é¢çŠ¶æ…‹ã‚’ç¶­æŒï¼‰
  
  // ä¿å­˜
  saveToStorage(STORAGE_KEYS.items, state.items);
  saveToStorage(STORAGE_KEYS.history, state.history);
  saveToStorage(STORAGE_KEYS.todayChecks, state.todayChecks);
  
  // å†æç”»
  renderEditList();
  renderHistory();
  if (state.currentShift) {
  renderChecklist();
  updateProgress();
  updateCompletedState();
  }
  
  modal.remove();
  alert(â€˜å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸï¼â€™);

```
} catch (e) {
  console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
  alert('ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
}
```

}

/**

- å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
  */
  function resetHistory() {
  // ç›´æ¥å‰Šé™¤ï¼ˆconfirmãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ç’°å¢ƒå¯¾ç­–ï¼‰
  state.history = [];
  saveToStorage(STORAGE_KEYS.history, state.history);
  renderHistory();
  updateCompletedState();
  alert(â€˜å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸâ€™);
  }
  window.resetHistory = resetHistory;

// ========================================
// ã‚·ãƒ•ãƒˆé¸æŠ
// ========================================

/**

- ã‚·ãƒ•ãƒˆã‚’é¸æŠ
- @param {string} shift
  */
  function selectShift(shift) {
  state.currentShift = shift;
  state.editingShift = shift;
  saveToStorage(STORAGE_KEYS.currentShift, shift);

```
document.getElementById('currentShiftName').textContent = shift;
document.getElementById('shiftSelectScreen').style.display = 'none';
document.getElementById('mainScreen').classList.add('active');

renderChecklist();
renderEditShiftTabs();
renderEditList();
updateProgress();
updateCompletedState();
```

}

/**

- ã‚·ãƒ•ãƒˆå¤‰æ›´ç”»é¢ã«æˆ»ã‚‹
  */
  function changeShift() {
  document.getElementById(â€˜shiftSelectScreenâ€™).style.display = â€˜blockâ€™;
  document.getElementById(â€˜mainScreenâ€™).classList.remove(â€˜activeâ€™);
  }

// ========================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// ========================================

/**

- ã‚¿ãƒ–ã‚’è¨­å®š
  */
  function setupTabs() {
  var tabs = document.querySelectorAll(â€™.tabâ€™);
  tabs.forEach(function(tab) {
  tab.addEventListener(â€˜clickâ€™, function() {
  var tabName = this.getAttribute(â€˜data-tabâ€™);
  
  tabs.forEach(function(t) {
  t.classList.remove(â€˜activeâ€™);
  });
  this.classList.add(â€˜activeâ€™);
  
  document.querySelectorAll(â€™.panelâ€™).forEach(function(panel) {
  panel.classList.remove(â€˜activeâ€™);
  });
  document.getElementById(tabName + â€˜Panelâ€™).classList.add(â€˜activeâ€™);
  });
  });
  }

// ========================================
// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
// ========================================

/**

- ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  */
  function setupEventListeners() {
  // ã‚·ãƒ•ãƒˆé¸æŠãƒœã‚¿ãƒ³
  document.querySelectorAll(â€™.shift-btnâ€™).forEach(function(btn) {
  btn.addEventListener(â€˜clickâ€™, function() {
  var shift = this.getAttribute(â€˜data-shiftâ€™);
  selectShift(shift);
  });
  });

```
// ã‚·ãƒ•ãƒˆå¤‰æ›´ãƒœã‚¿ãƒ³
document.getElementById('changeShiftBtn').addEventListener('click', changeShift);

// å®Œäº†å–ã‚Šæ¶ˆã—ãƒœã‚¿ãƒ³
document.getElementById('undoCompleteBtn').addEventListener('click', undoComplete);

// å®Œäº†ãƒœã‚¿ãƒ³
document.getElementById('completeBtn').addEventListener('click', completeCheck);

// é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³
document.getElementById('addItemBtn').addEventListener('click', addItem);

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
document.getElementById('editModalCancel').addEventListener('click', closeEditModal);
document.getElementById('editModalConfirm').addEventListener('click', confirmEdit);

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ
document.getElementById('exportBackupBtn').addEventListener('click', function(e) {
  e.preventDefault();
  exportBackup();
});
document.getElementById('showRestoreBtn').addEventListener('click', function(e) {
  e.preventDefault();
  showRestoreModal();
});
document.getElementById('resetHistoryBtn').addEventListener('click', function(e) {
  e.preventDefault();
  resetHistory();
});

// ã‚¿ãƒ–
setupTabs();

// æ›œæ—¥é¸æŠãƒ­ã‚¸ãƒƒã‚¯
setupDaySelectLogic('newItemDays');

// ãƒšãƒ¼ã‚¸ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸæ™‚ã«æ—¥ä»˜å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
document.addEventListener('visibilitychange', function() {
  if (!document.hidden && checkDateChange()) {
    renderChecklist();
    updateProgress();
    updateCompletedState();
  }
});
```

}

// ========================================
// åˆæœŸåŒ–
// ========================================

/**

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
  */
  function init() {
  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  var rawItems = loadFromStorage(STORAGE_KEYS.items, null);
  if (rawItems === null) {
  state.items = createDefaultItems();
  saveToStorage(STORAGE_KEYS.items, state.items);
  } else {
  state.items = migrateItems(rawItems);
  // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
  saveToStorage(STORAGE_KEYS.items, state.items);
  }

```
state.todayChecks = loadFromStorage(STORAGE_KEYS.todayChecks, {});
state.history = migrateHistory(loadFromStorage(STORAGE_KEYS.history, []));
state.currentShift = loadFromStorage(STORAGE_KEYS.currentShift, null);
state.editingShift = state.currentShift || SHIFTS[0];

// æ—¥ä»˜å¤‰æ›´ãƒã‚§ãƒƒã‚¯
if (checkDateChange()) {
  state.todayChecks = {};
}

// UIåˆæœŸåŒ–
document.getElementById('dateDisplay').textContent = getTodayString();

if (state.currentShift) {
  document.getElementById('currentShiftName').textContent = state.currentShift;
  document.getElementById('shiftSelectScreen').style.display = 'none';
  document.getElementById('mainScreen').classList.add('active');
}

renderChecklist();
renderEditShiftTabs();
renderEditList();
renderHistory();
updateProgress();
updateCompletedState();
setupEventListeners();
```

}

// ã‚¢ãƒ—ãƒªèµ·å‹•
if (document.readyState === â€˜loadingâ€™) {
document.addEventListener(â€˜DOMContentLoadedâ€™, init);
} else {
init();
}

})();
</script>

</body>
</html>
