<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#F5F0E8">
<title>Êñ∞Ê¥•Â∫ó„É´„Éº„ÉÜ„Ç£„É≥Ê•≠Âãô</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
  background: #FAF9F6;
  min-height: 100vh;
  color: #1a1a1a;
  line-height: 1.6;
  padding-bottom: env(safe-area-inset-bottom);
}
.container {
  max-width: 600px;
  margin: 0 auto;
  padding: 0 20px 120px;
}
header {
  padding: 48px 20px 24px;
  text-align: center;
}
header h1 {
  font-size: 1.75rem;
  font-weight: 600;
  background: linear-gradient(135deg, #B8860B 0%, #DAA520 50%, #B8860B 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 4px;
}
.version {
  font-size: 0.7rem;
  color: #9b9b9b;
  letter-spacing: 0.1em;
}
.date-display {
  font-size: 0.9rem;
  color: #6b6b6b;
  margin-top: 4px;
}
.shift-select-screen {
  padding: 40px 0;
}
.shift-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.shift-btn {
  padding: 20px 24px;
  background: #fff;
  border: 1px solid #E5E2DC;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  text-align: left;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.shift-btn .time {
  font-size: 0.85rem;
  color: #6b6b6b;
}
.main-screen {
  display: none;
}
.main-screen.active {
  display: block;
}
.shift-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid #E5E2DC;
}
.current-shift {
  font-size: 1.2rem;
  font-weight: 600;
}
.change-btn {
  padding: 8px 16px;
  background: transparent;
  border: 1px solid #D4CFC5;
  border-radius: 8px;
  font-size: 0.85rem;
  color: #6b6b6b;
  cursor: pointer;
}
.progress-section {
  margin-bottom: 24px;
  background: #fff;
  padding: 15px;
  border-radius: 12px;
  border: 1px solid #E5E2DC;
}
.progress-bar {
  height: 6px;
  background: #E8E4DB;
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 8px;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #B8860B, #DAA520);
  transition: width 0.3s ease;
}
.progress-text {
  font-size: 0.85rem;
  color: #6b6b6b;
  text-align: right;
}
.checklist {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.checklist-item {
  display: flex;
  align-items: center;
  padding: 16px;
  background: #fff;
  border: 1px solid #E5E2DC;
  border-radius: 10px;
  gap: 12px;
  cursor: pointer;
}
.checklist-item.checked {
  background: #F5F0E8;
  border-color: #D4CFC5;
}
.checklist-item .item-text {
  flex: 1;
  font-size: 0.95rem;
}
.checklist-item.checked .item-text {
  color: #8B7355;
  text-decoration: line-through;
}
.custom-checkbox {
  position: relative;
  width: 24px;
  height: 24px;
  flex-shrink: 0;
}
.custom-checkbox input {
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
  z-index: 2;
  margin: 0;
}
.checkmark {
  position: absolute;
  top: 0;
  left: 0;
  width: 24px;
  height: 24px;
  background: #fff;
  border: 2px solid #D4CFC5;
  border-radius: 6px;
}
.custom-checkbox input:checked + .checkmark {
  background: #B8860B;
  border-color: #B8860B;
}
.custom-checkbox input:checked + .checkmark::after {
  content: '';
  position: absolute;
  left: 7px;
  top: 3px;
  width: 6px;
  height: 11px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}
.day-badge {
  font-size: 0.75rem;
  padding: 2px 8px;
  background: #E8E4DB;
  color: #6b6b6b;
  border-radius: 4px;
}
.nav-tabs {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid #E5E2DC;
  display: flex;
  justify-content: space-around;
  padding: 12px 0;
  z-index: 100;
  padding-bottom: calc(12px + env(safe-area-inset-bottom));
}
.tab {
  padding: 8px 20px;
  background: transparent;
  border: none;
  font-size: 0.9rem;
  color: #9b9b9b;
  border-radius: 8px;
  cursor: pointer;
}
.tab.active {
  background: #F5F0E8;
  color: #B8860B;
  font-weight: 600;
}
.panel {
  display: none;
}
.panel.active {
  display: block;
}
.edit-shift-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.edit-shift-tab {
  padding: 8px 16px;
  background: #fff;
  border: 1px solid #E5E2DC;
  border-radius: 8px;
  font-size: 0.85rem;
  color: #6b6b6b;
  cursor: pointer;
}
.edit-shift-tab.active {
  background: #B8860B;
  color: #fff;
  border-color: #B8860B;
}
.add-item-section {
  background: #fff;
  border: 1px solid #E5E2DC;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
}
.add-item-section input[type="text"] {
  width: 100%;
  padding: 12px;
  border: 1px solid #E5E2DC;
  border-radius: 8px;
  font-size: 16px;
  margin-bottom: 12px;
}
.day-select {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}
.day-select label {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  background: #F5F0E8;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
}
.day-select input {
  display: none;
}
.day-select input:checked + span {
  color: #B8860B;
  font-weight: 600;
}
.date-input-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  font-size: 0.9rem;
  color: #6b6b6b;
}
.date-input-row input {
  width: 60px;
  padding: 8px;
  border: 1px solid #E5E2DC;
  border-radius: 6px;
  font-size: 16px;
}
.add-btn {
  width: 100%;
  padding: 12px;
  background: #B8860B;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
}
.edit-list {
  list-style: none;
}
.edit-list-item {
  background: #fff;
  border: 1px solid #E5E2DC;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 10px;
}
.edit-item-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
}
.edit-item-bottom {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #eee;
  flex-wrap: wrap;
}
.move-btn, .edit-btn {
  background: #E8E4DB;
  color: #6b6b6b;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  cursor: pointer;
}
.delete-btn {
  color: #C53030;
  background: #FEE;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  cursor: pointer;
}
.complete-btn {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, #B8860B, #DAA520);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  margin-top: 20px;
  cursor: pointer;
}
.complete-btn:disabled {
  background: #E8E4DB;
  color: #9b9b9b;
}
.already-completed {
  background: #E6F4EA;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  margin-bottom: 15px;
}
.undo-btn {
  margin-top: 12px;
  font-size: 0.85rem;
  background: #fff;
  border: 1px solid #ccc;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
}
.history-item {
  background: #fff;
  border: 1px solid #E5E2DC;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 10px;
}
.history-date {
  font-weight: 600;
  margin-bottom: 4px;
}
.history-shift {
  font-size: 0.85rem;
  color: #6b6b6b;
  margin-bottom: 8px;
}
.history-status {
  display: flex;
  align-items: center;
  gap: 10px;
}
.badge {
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 500;
}
.badge.complete {
  background: #D4EDDA;
  color: #155724;
}
.history-details {
  margin-top: 10px;
}
.history-details summary {
  font-size: 0.85rem;
  color: #6b6b6b;
  cursor: pointer;
}
.history-details ul {
  margin-top: 8px;
  padding-left: 20px;
}
.history-details li {
  font-size: 0.85rem;
  color: #6b6b6b;
}
.history-details li.checked {
  color: #155724;
}
.no-history {
  text-align: center;
  color: #9b9b9b;
  padding: 40px 0;
}
.backup-section {
  background: #F5F0E8;
  border: 1px solid #E5E2DC;
  border-radius: 10px;
  padding: 16px;
  margin-top: 20px;
}
.backup-section h4 {
  font-size: 0.9rem;
  margin-bottom: 12px;
}
.backup-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.backup-btn, .restore-btn {
  padding: 12px;
  border: 1px solid #D4CFC5;
  border-radius: 8px;
  font-size: 0.85rem;
  cursor: pointer;
  text-align: center;
}
.backup-btn {
  background: #fff;
}
.restore-btn {
  background: #E8E4DB;
}
.reset-btn {
  width: 100%;
  padding: 14px;
  background: transparent;
  color: #C53030;
  border: 1px solid #FCC;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  margin-top: 20px;
}
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal-overlay.show {
  display: flex;
}
.modal {
  background: #fff;
  border-radius: 16px;
  padding: 24px;
  width: 100%;
  max-width: 400px;
}
.modal h3 {
  margin-bottom: 16px;
}
.modal input[type="text"] {
  width: 100%;
  padding: 12px;
  border: 1px solid #E5E2DC;
  border-radius: 8px;
  font-size: 16px;
  margin-bottom: 12px;
}
.modal-buttons {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}
.modal-cancel, .modal-confirm {
  flex: 1;
  padding: 12px;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  border: none;
}
.modal-cancel {
  background: #E8E4DB;
  color: #6b6b6b;
}
.modal-confirm {
  background: #B8860B;
  color: #fff;
}
</style>
</head>
<body>
<header>
  <h1>Êñ∞Ê¥•Â∫ó„É´„Éº„ÉÜ„Ç£„É≥Ê•≠Âãô</h1>
  <div class="version">ver 2.0</div>
  <div class="date-display" id="dateDisplay"></div>
</header>

<div class="container">
  <div id="shiftSelectScreen" class="shift-select-screen">
    <h2 style="text-align:center;margin-bottom:24px;font-size:1.1rem;">„Ç∑„Éï„Éà„ÇíÈÅ∏Êäû</h2>
    <div class="shift-buttons">
      <button class="shift-btn" data-shift="Ë∂ÖÊó©"><span>Ë∂ÖÊó©</span><span class="time">7:00-16:00</span></button>
      <button class="shift-btn" data-shift="Êó©Áï™"><span>Êó©Áï™</span><span class="time">9:00-18:00</span></button>
      <button class="shift-btn" data-shift="‰∏≠Áï™"><span>‰∏≠Áï™</span><span class="time">11:00-20:00</span></button>
      <button class="shift-btn" data-shift="ÈÅÖÁï™"><span>ÈÅÖÁï™</span><span class="time">14:30-23:30</span></button>
    </div>
  </div>

  <div id="mainScreen" class="main-screen">
    <div class="nav-tabs">
      <button class="tab active" data-tab="check">„ÉÅ„Çß„ÉÉ„ÇØ</button>
      <button class="tab" data-tab="edit">È†ÖÁõÆÁ∑®ÈõÜ</button>
      <button class="tab" data-tab="history">Â±•Ê≠¥</button>
    </div>

    <div id="checkPanel" class="panel active">
      <div class="shift-header">
        <span class="current-shift" id="currentShiftName"></span>
        <button class="change-btn" id="changeShiftBtn">Â§âÊõ¥</button>
      </div>
      <div id="alreadyCompleted" class="already-completed" style="display:none;">
        ‚úì Êú¨Êó•ÂÆå‰∫ÜÊ∏à„Åø
        <button class="undo-btn" id="undoCompleteBtn">ÂèñÊ∂à</button>
      </div>
      <div class="progress-section" id="progressSection">
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        <div id="progressText" class="progress-text">0/0</div>
      </div>
      <div id="checklist" class="checklist"></div>
      <button id="completeBtn" class="complete-btn" disabled>ÂÆå‰∫Ü</button>
    </div>

    <div id="editPanel" class="panel">
      <div id="editShiftTabs" class="edit-shift-tabs"></div>
      <div class="add-item-section">
        <input type="text" id="newItemText" placeholder="Êñ∞„Åó„ÅÑÈ†ÖÁõÆ">
        <div class="day-select" id="newItemDays">
          <label><input type="checkbox" value="ÊØéÊó•" checked><span>ÊØéÊó•</span></label>
          <label><input type="checkbox" value="Êúà"><span>Êúà</span></label>
          <label><input type="checkbox" value="ÁÅ´"><span>ÁÅ´</span></label>
          <label><input type="checkbox" value="Ê∞¥"><span>Ê∞¥</span></label>
          <label><input type="checkbox" value="Êú®"><span>Êú®</span></label>
          <label><input type="checkbox" value="Èáë"><span>Èáë</span></label>
          <label><input type="checkbox" value="Âúü"><span>Âúü</span></label>
          <label><input type="checkbox" value="Êó•"><span>Êó•</span></label>
        </div>
        <div class="date-input-row">
          <span>ÁâπÂÆöÊó•:</span>
          <input type="number" id="newItemDate" min="1" max="31" placeholder="-">
          <span>Êó•</span>
        </div>
        <button class="add-btn" id="addItemBtn">ËøΩÂä†</button>
      </div>
      <ul id="editList" class="edit-list"></ul>
    </div>

    <div id="historyPanel" class="panel">
      <div id="historyList"></div>
      <div class="backup-section">
        <h4>„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</h4>
        <div class="backup-buttons">
          <button class="backup-btn" onclick="window.exportBackup()">üì§ „Ç≥„Éî„Éº</button>
          <button class="restore-btn" onclick="window.showRestoreModal()">üì• Âæ©ÂÖÉ</button>
        </div>
      </div>
      <button class="reset-btn" onclick="window.resetHistory()">Â±•Ê≠¥„ÇØ„É™„Ç¢</button>
    </div>
  </div>
</div>

<div id="editModal" class="modal-overlay">
  <div class="modal">
    <h3>È†ÖÁõÆ„ÇíÁ∑®ÈõÜ</h3>
    <input type="text" id="editItemInput">
    <div class="day-select" id="editItemDays"></div>
    <div class="date-input-row">
      <span>ÁâπÂÆöÊó•:</span>
      <input type="number" id="editItemDate" min="1" max="31" placeholder="-">
      <span>Êó•</span>
    </div>
    <div class="modal-buttons">
      <button class="modal-cancel" id="editModalCancel">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="modal-confirm" id="editModalConfirm">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<script>
(function() {
var STORAGE_KEYS = {
  items: 'niitsu_routine_items_v3',
  todayChecks: 'niitsu_routine_checks_v3',
  history: 'niitsu_routine_hist_v3',
  currentShift: 'niitsu_routine_shift',
  lastDate: 'niitsu_routine_date'
};
var SHIFTS = ['Ë∂ÖÊó©', 'Êó©Áï™', '‰∏≠Áï™', 'ÈÅÖÁï™'];
var DAY_NAMES = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
var state = {
  items: {},
  todayChecks: {},
  history: [],
  currentShift: null,
  editingShift: null,
  editingIndex: -1
};

function generateId() {
  return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
}
function getTodayKey() {
  var d = new Date();
  return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
}
function getTodayString() {
  return new Date().toLocaleDateString('ja-JP', {year:'numeric',month:'long',day:'numeric',weekday:'long'});
}
function getTodayDayName() {
  return DAY_NAMES[new Date().getDay()];
}
function getTodayDate() {
  return new Date().getDate();
}
function loadFromStorage(key, defaultValue) {
  try {
    var data = localStorage.getItem(key);
    if (data === null) return defaultValue;
    var parsed = JSON.parse(data);
    return parsed !== null ? parsed : defaultValue;
  } catch (e) {
    return defaultValue;
  }
}
function saveToStorage(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {}
}
function shouldShowItem(item) {
  var todayDate = getTodayDate();
  var todayDayName = getTodayDayName();
  if (item.date) {
    return parseInt(item.date) === todayDate;
  }
  if (!item.days || item.days.length === 0) return true;
  if (item.days.indexOf('ÊØéÊó•') !== -1) return true;
  if (item.days.indexOf(todayDayName) !== -1) return true;
  return false;
}
function getItemDayLabel(item) {
  if (item.date) return item.date + 'Êó•';
  if (item.days && item.days.length > 0 && item.days.indexOf('ÊØéÊó•') === -1) {
    return item.days.join('„Éª');
  }
  return '';
}
function createDefaultItems() {
  return {
    'Ë∂ÖÊó©': [
      {id:generateId(),text:'Á§æÂì°‚ë†Ôºó:00ÊúùÁ§º',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë†Â£≤Â§âÔºàÂâçÊó•Â§ú„Å†„ÅåÂΩìÊó•Âá∫Âäõ„Åï„Çå„ÅüÂ†¥Âêà„ÅØÂÆüÊñΩÔºâ',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë†Âèñ„ÇäÂØÑ„ÅõÁô∫Ê≥®',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë†„Éù„Çπ„ÉàÁ¢∫Ë™ç',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë†Ê¨†ÂìÅ„É™„Çπ„ÉàÂç∞Âà∑',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë†ÈùíÊûúÂ∞éÂÖ•„É™„Çπ„ÉàÂç∞Âà∑',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë°8:30ÊúùÁ§º',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë°Êú¨ÈÉ®‰æøÂá¶ÁêÜ',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë°Ë≤©‰øÉPOPË≤ºÔºà„ÅÆ„Åº„ÇäÔºâ',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë°Ê∞¥Êäú„ÅçÔºà6/1-9/30Ôºâ',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë°Âèñ„ÇäÂØÑ„ÅõÁ¢∫Ë™çÔºàÈ£≤Êñô„ÇÇÔºâ',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë°Ôºë‰æø„ÇíÔºòÊôÇ„Åæ„Åß„Å´‰∏≠„Å´ÂÖ•„Çå„Çã',days:['ÊØéÊó•'],date:null}
    ],
    'Êó©Áï™': [
      {id:generateId(),text:'Á§æÂì°‚ë¢‰ªïÂàÜ„ÅëÔºàÈ£≤ÊñôÂìÅÂá∫„Åó„ÅÆ„ÅÇ„Å®Ôºâ',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë¢Áü•‰πÖÂ±ãÂ£≤‰∏ä',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Á§æÂì°‚ë¢„Éà„Éä„Éº„ÄÅ„É©„ÉüÁ¢∫Ë™çÔºàÊó•ÊõúÊó•„ÅÆ„ÅøÔºâ',days:['Êó•'],date:null}
    ],
    '‰∏≠Áï™': [],
    'ÈÅÖÁï™': [
      {id:generateId(),text:'Èüø„Åç„ÇÑFAXÔºàÊúàÊõú„ÅÆ„ÅøÔºâ',days:['Êúà'],date:null},
      {id:generateId(),text:'HACCAP„ÉÅ„Çß„ÉÉ„ÇØ',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÅäÂÆ¢Êßò„ÅÆÂ£∞ÂõûÂèé',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'Â§úÂ£≤Â§âÔºàÂÄ§‰∏ã„ÅØÈñâÂ∫óÂæåPOPË®≠ÁΩÆÔºâ',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÈáëÂà∏„ÄëÈáëÂà∏„ÄÅ„É¨„Ç∏„Éû„Ç§„É¨„Ç∑„Éº„ÉàÂõûÂèé',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÈáëÂà∏„ÄëÂèñ„ÇäÂØÑ„ÅõÂà∏„ÄÅ„Éù„Ç§„É≥„Éà„ÅÆ„Ç´„Éº„ÉâÈñ¢ÈÄ£„ÄÅipadÂõûÂèé',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÈáëÂà∏„Äë„É¨„Ç∏Êó•Â†±„ÄÅÈÅïÁÆóÈáëË®òÂÖ•',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÈáëÂà∏„ÄëÊÆãÊ•≠„É°„Éº„É´‰ΩúÊàê',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÁèæÈáë„Äë„É¨„Ç∏‰∏°Êõø',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÁèæÈáë„ÄëÈáëÂ∫´ÂÜÖÁÇπÊ§ú',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÁèæÈáë„ÄëÂ£≤‰∏äÈáëÂõûÂèé',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÁèæÈáë„Äë„Ç¢„É´„ÇΩ„ÉÉ„ÇØ‰∏°ÊõøÔºàÊó•„ÄÅÊú®Ôºâ',days:['Êó•','Êú®'],date:null},
      {id:generateId(),text:'„ÄêÁ¢∫Ë™ç„ÄëHACCAP„ÄÅË≤©Â£≤ÁÆ°ÁêÜË®òÈå≤Ë®òÂÖ•',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÁ¢∫Ë™ç„ÄëË≤©‰øÉPOP„Å®„Çä',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÁ¢∫Ë™ç„ÄëÈùíÊûúÊ∞¥Êäú„ÅçÔºàÂ§èÔºâ',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÁ¢∫Ë™ç„ÄëËÉΩÂãïÂÖ•Âäõ',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÁ¢∫Ë™ç„ÄëÊµ∑ÂïÜÂ†±Âëä',days:['ÊØéÊó•'],date:null},
      {id:generateId(),text:'„ÄêÁ¢∫Ë™ç„ÄëÈùíÊûúÂÆ§„ÅßHACCAP„Çµ„Ç§„É≥',days:['ÊØéÊó•'],date:null}
    ]
  };
}
function getCheckKey(shift, itemId) {
  return getTodayKey() + '_' + shift + '_' + itemId;
}
function isItemChecked(itemId) {
  return !!state.todayChecks[getCheckKey(state.currentShift, itemId)];
}
function toggleItemCheck(itemId) {
  var key = getCheckKey(state.currentShift, itemId);
  state.todayChecks[key] = !state.todayChecks[key];
  saveToStorage(STORAGE_KEYS.todayChecks, state.todayChecks);
  renderChecklist();
  updateProgress();
}
function getVisibleItems() {
  if (!state.currentShift || !state.items[state.currentShift]) return [];
  return state.items[state.currentShift].filter(shouldShowItem);
}
function canComplete() {
  var visible = getVisibleItems();
  if (visible.length === 0) return false;
  return visible.every(function(item) { return isItemChecked(item.id); });
}
function checkDateChange() {
  var lastDate = localStorage.getItem(STORAGE_KEYS.lastDate);
  var today = getTodayKey();
  if (lastDate !== today) {
    localStorage.setItem(STORAGE_KEYS.lastDate, today);
    state.todayChecks = {};
    saveToStorage(STORAGE_KEYS.todayChecks, state.todayChecks);
    return true;
  }
  return false;
}
function isAlreadyCompleted() {
  var todayKey = getTodayKey();
  return state.history.some(function(r) {
    return r.dateKey === todayKey && r.shift === state.currentShift && r.allChecked;
  });
}
function completeCheck() {
  if (!canComplete()) return;
  var visible = getVisibleItems();
  var checkedItems = {};
  visible.forEach(function(item) {
    checkedItems[item.id] = {text: item.text, checked: isItemChecked(item.id)};
  });
  var now = new Date();
  state.history.unshift({
    dateKey: getTodayKey(),
    date: getTodayString(),
    shift: state.currentShift,
    time: now.getHours() + ':' + ('0' + now.getMinutes()).slice(-2),
    checkedItems: checkedItems,
    allChecked: true
  });
  if (state.history.length > 100) state.history = state.history.slice(0, 100);
  saveToStorage(STORAGE_KEYS.history, state.history);
  alert('ÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
  updateCompletedState();
  renderHistory();
}
function undoComplete() {
  var todayKey = getTodayKey();
  state.history = state.history.filter(function(r) {
    return !(r.dateKey === todayKey && r.shift === state.currentShift);
  });
  saveToStorage(STORAGE_KEYS.history, state.history);
  renderChecklist();
  updateProgress();
  updateCompletedState();
  renderHistory();
}
function renderChecklist() {
  var container = document.getElementById('checklist');
  container.innerHTML = '';
  var visible = getVisibleItems();
  if (visible.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Êú¨Êó•„ÅÆÈ†ÖÁõÆ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    return;
  }
  visible.forEach(function(item) {
    var checked = isItemChecked(item.id);
    var div = document.createElement('div');
    div.className = 'checklist-item' + (checked ? ' checked' : '');
    div.setAttribute('data-id', item.id);
    var cb = document.createElement('div');
    cb.className = 'custom-checkbox';
    var input = document.createElement('input');
    input.type = 'checkbox';
    input.checked = checked;
    input.addEventListener('click', function(e) { e.stopPropagation(); });
    input.addEventListener('change', function() { toggleItemCheck(item.id); });
    var mark = document.createElement('span');
    mark.className = 'checkmark';
    cb.appendChild(input);
    cb.appendChild(mark);
    var text = document.createElement('span');
    text.className = 'item-text';
    text.textContent = item.text;
    div.appendChild(cb);
    div.appendChild(text);
    var label = getItemDayLabel(item);
    if (label) {
      var badge = document.createElement('span');
      badge.className = 'day-badge';
      badge.textContent = label;
      div.appendChild(badge);
    }
    div.addEventListener('click', function(e) {
      if (e.target.tagName !== 'INPUT') toggleItemCheck(item.id);
    });
    container.appendChild(div);
  });
  updateCompletedState();
}
function updateProgress() {
  var visible = getVisibleItems();
  var total = visible.length;
  var checked = visible.filter(function(item) { return isItemChecked(item.id); }).length;
  var pct = total > 0 ? (checked / total) * 100 : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = checked + '/' + total;
  document.getElementById('completeBtn').disabled = !canComplete();
}
function updateCompletedState() {
  var done = isAlreadyCompleted();
  document.getElementById('alreadyCompleted').style.display = done ? 'block' : 'none';
  document.getElementById('checklist').style.display = done ? 'none' : 'flex';
  document.getElementById('progressSection').style.display = done ? 'none' : 'block';
  document.getElementById('completeBtn').style.display = done ? 'none' : 'block';
}
function renderEditShiftTabs() {
  var container = document.getElementById('editShiftTabs');
  container.innerHTML = '';
  SHIFTS.forEach(function(shift) {
    var btn = document.createElement('button');
    btn.className = 'edit-shift-tab' + (shift === state.editingShift ? ' active' : '');
    btn.textContent = shift;
    btn.addEventListener('click', function() {
      state.editingShift = shift;
      renderEditShiftTabs();
      renderEditList();
    });
    container.appendChild(btn);
  });
}
function renderEditList() {
  var container = document.getElementById('editList');
  container.innerHTML = '';
  if (!state.editingShift || !state.items[state.editingShift]) return;
  state.items[state.editingShift].forEach(function(item, index) {
    var li = document.createElement('li');
    li.className = 'edit-list-item';
    var top = document.createElement('div');
    top.className = 'edit-item-top';
    var txt = document.createElement('span');
    txt.textContent = item.text;
    top.appendChild(txt);
    var label = getItemDayLabel(item);
    if (label) {
      var badge = document.createElement('span');
      badge.className = 'day-badge';
      badge.textContent = label;
      top.appendChild(badge);
    }
    var bottom = document.createElement('div');
    bottom.className = 'edit-item-bottom';
    var upBtn = document.createElement('button');
    upBtn.className = 'move-btn';
    upBtn.textContent = '‚Üë';
    upBtn.onclick = function() { moveItem(index, -1); };
    var downBtn = document.createElement('button');
    downBtn.className = 'move-btn';
    downBtn.textContent = '‚Üì';
    downBtn.onclick = function() { moveItem(index, 1); };
    var editBtn = document.createElement('button');
    editBtn.className = 'edit-btn';
    editBtn.textContent = 'Á∑®ÈõÜ';
    editBtn.onclick = function() { openEditModal(index); };
    var delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.textContent = 'ÂâäÈô§';
    delBtn.onclick = function() { deleteItem(index); };
    bottom.appendChild(upBtn);
    bottom.appendChild(downBtn);
    bottom.appendChild(editBtn);
    bottom.appendChild(delBtn);
    li.appendChild(top);
    li.appendChild(bottom);
    container.appendChild(li);
  });
}
function renderHistory() {
  var container = document.getElementById('historyList');
  if (state.history.length === 0) {
    container.innerHTML = '<div class="no-history">Â±•Ê≠¥„Å™„Åó</div>';
    return;
  }
  var html = '';
  state.history.slice(0, 50).forEach(function(r) {
    var items = r.checkedItems || {};
    var ids = Object.keys(items);
    var total = ids.length;
    var checked = ids.filter(function(id) { return items[id].checked; }).length;
    var listHtml = ids.map(function(id) {
      var it = items[id];
      return '<li class="' + (it.checked ? 'checked' : '') + '">' + (it.checked ? '‚úì ' : '‚àí ') + it.text + '</li>';
    }).join('');
    html += '<div class="history-item">' +
      '<div class="history-date">' + r.date + '</div>' +
      '<div class="history-shift">' + r.shift + '</div>' +
      '<div class="history-status"><span class="badge complete">ÂÆå‰∫Ü</span><span>' + checked + '/' + total + ' ' + r.time + '</span></div>' +
      '<details class="history-details"><summary>Ë©≥Á¥∞</summary><ul>' + listHtml + '</ul></details></div>';
  });
  container.innerHTML = html;
}
function addItem() {
  var text = document.getElementById('newItemText').value.trim();
  if (!text) return alert('È†ÖÁõÆ„ÇíÂÖ•Âäõ');
  var days = [];
  document.querySelectorAll('#newItemDays input:checked').forEach(function(c) { days.push(c.value); });
  var date = document.getElementById('newItemDate').value || null;
  if (date) days = [];
  if (!state.items[state.editingShift]) state.items[state.editingShift] = [];
  state.items[state.editingShift].push({id: generateId(), text: text, days: days, date: date});
  saveToStorage(STORAGE_KEYS.items, state.items);
  document.getElementById('newItemText').value = '';
  document.getElementById('newItemDate').value = '';
  renderEditList();
  if (state.editingShift === state.currentShift) { renderChecklist(); updateProgress(); }
}
function moveItem(index, dir) {
  var arr = state.items[state.editingShift];
  var newIdx = index + dir;
  if (newIdx < 0 || newIdx >= arr.length) return;
  var tmp = arr[index]; arr[index] = arr[newIdx]; arr[newIdx] = tmp;
  saveToStorage(STORAGE_KEYS.items, state.items);
  renderEditList();
  if (state.editingShift === state.currentShift) renderChecklist();
}
function deleteItem(index) {
  state.items[state.editingShift].splice(index, 1);
  saveToStorage(STORAGE_KEYS.items, state.items);
  renderEditList();
  if (state.editingShift === state.currentShift) { renderChecklist(); updateProgress(); }
}
function openEditModal(index) {
  state.editingIndex = index;
  var item = state.items[state.editingShift][index];
  document.getElementById('editItemInput').value = item.text;
  document.getElementById('editItemDate').value = item.date || '';
  var dc = document.getElementById('editItemDays');
  dc.innerHTML = '';
  ['ÊØéÊó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü','Êó•'].forEach(function(d) {
    var lbl = document.createElement('label');
    var inp = document.createElement('input');
    inp.type = 'checkbox'; inp.value = d;
    inp.checked = item.days && item.days.indexOf(d) !== -1;
    var sp = document.createElement('span'); sp.textContent = d;
    lbl.appendChild(inp); lbl.appendChild(sp);
    dc.appendChild(lbl);
  });
  document.getElementById('editModal').classList.add('show');
}
function closeEditModal() { document.getElementById('editModal').classList.remove('show'); }
function confirmEdit() {
  var text = document.getElementById('editItemInput').value.trim();
  if (!text) return alert('È†ÖÁõÆ„ÇíÂÖ•Âäõ');
  var days = [];
  document.querySelectorAll('#editItemDays input:checked').forEach(function(c) { days.push(c.value); });
  var date = document.getElementById('editItemDate').value || null;
  if (date) days = [];
  var item = state.items[state.editingShift][state.editingIndex];
  item.text = text; item.days = days; item.date = date;
  saveToStorage(STORAGE_KEYS.items, state.items);
  closeEditModal();
  renderEditList();
  if (state.editingShift === state.currentShift) { renderChecklist(); updateProgress(); }
}
function selectShift(shift) {
  state.currentShift = shift;
  state.editingShift = shift;
  saveToStorage(STORAGE_KEYS.currentShift, shift);
  document.getElementById('currentShiftName').textContent = shift;
  document.getElementById('shiftSelectScreen').style.display = 'none';
  document.getElementById('mainScreen').classList.add('active');
  renderChecklist(); renderEditShiftTabs(); renderEditList(); updateProgress(); updateCompletedState();
}
function changeShift() {
  document.getElementById('shiftSelectScreen').style.display = 'block';
  document.getElementById('mainScreen').classList.remove('active');
}
window.exportBackup = function() {
  var data = JSON.stringify({items: state.items, history: state.history, todayChecks: state.todayChecks});
  prompt('„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', data);
};
window.showRestoreModal = function() {
  var data = prompt('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíË≤º„Çä‰ªò„Åë:');
  if (!data) return;
  try {
    var b = JSON.parse(data);
    if (b.items) { state.items = b.items; saveToStorage(STORAGE_KEYS.items, state.items); }
    if (b.history) { state.history = b.history; saveToStorage(STORAGE_KEYS.history, state.history); }
    if (b.todayChecks) { state.todayChecks = b.todayChecks; saveToStorage(STORAGE_KEYS.todayChecks, state.todayChecks); }
    alert('Âæ©ÂÖÉÂÆå‰∫Ü'); location.reload();
  } catch(e) { alert('„Éá„Éº„Çø„Åå‰∏çÊ≠£„Åß„Åô'); }
};
window.resetHistory = function() {
  state.history = [];
  saveToStorage(STORAGE_KEYS.history, state.history);
  renderHistory();
  updateCompletedState();
};
function init() {
  var saved = loadFromStorage(STORAGE_KEYS.items, null);
  state.items = saved || createDefaultItems();
  if (!saved) saveToStorage(STORAGE_KEYS.items, state.items);
  state.todayChecks = loadFromStorage(STORAGE_KEYS.todayChecks, {});
  state.history = loadFromStorage(STORAGE_KEYS.history, []);
  state.currentShift = loadFromStorage(STORAGE_KEYS.currentShift, null);
  state.editingShift = state.currentShift || SHIFTS[0];
  checkDateChange();
  document.getElementById('dateDisplay').textContent = getTodayString();
  if (state.currentShift) {
    document.getElementById('currentShiftName').textContent = state.currentShift;
    document.getElementById('shiftSelectScreen').style.display = 'none';
    document.getElementById('mainScreen').classList.add('active');
  }
  renderChecklist(); renderEditShiftTabs(); renderEditList(); renderHistory(); updateProgress(); updateCompletedState();
  document.querySelectorAll('.shift-btn').forEach(function(b) {
    b.addEventListener('click', function() { selectShift(this.dataset.shift); });
  });
  document.getElementById('changeShiftBtn').addEventListener('click', changeShift);
  document.getElementById('undoCompleteBtn').addEventListener('click', undoComplete);
  document.getElementById('completeBtn').addEventListener('click', completeCheck);
  document.getElementById('addItemBtn').addEventListener('click', addItem);
  document.getElementById('editModalCancel').addEventListener('click', closeEditModal);
  document.getElementById('editModalConfirm').addEventListener('click', confirmEdit);
  document.querySelectorAll('.tab').forEach(function(t) {
    t.addEventListener('click', function() {
      document.querySelectorAll('.tab').forEach(function(x) { x.classList.remove('active'); });
      this.classList.add('active');
      document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
      document.getElementById(this.dataset.tab + 'Panel').classList.add('active');
    });
  });
}
init();
})();
</script>
</body>
</html>
