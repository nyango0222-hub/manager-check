<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æ¥­å‹™">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#2E7D32">
<meta name="format-detection" content="telephone=no">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232E7D32' width='100' height='100' rx='20'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='white'>âœ“</text></svg>">
<title>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æ¥­å‹™</title>
<style>
/* ========================================
   ãƒªã‚»ãƒƒãƒˆãƒ»åŸºæœ¬è¨­å®š
======================================== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

input, textarea {
-webkit-user-select: text;
-moz-user-select: text;
-ms-user-select: text;
user-select: text;
}

body {
font-family: -apple-system, BlinkMacSystemFont, â€˜Helvetica Neueâ€™, sans-serif;
background: #FAF9F6;
min-height: 100vh;
color: #1a1a1a;
line-height: 1.6;
padding-bottom: env(safe-area-inset-bottom);
padding-top: env(safe-area-inset-top);
}

@keyframes popBounce {
0% { transform: scale(1); }
30% { transform: scale(1.15); }
50% { transform: scale(0.95); }
70% { transform: scale(1.05); }
100% { transform: scale(1); }
}

.checklist-item.pop-animation {
animation: popBounce 0.3s ease-out;
}

/* ========================================
ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
======================================== */
.container {
max-width: 600px;
margin: 0 auto;
padding: 0 20px 120px;
}

header {
padding: 48px 20px 24px;
text-align: center;
}

header h1 {
font-size: 1.6rem;
font-weight: 600;
background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 50%, #2E7D32 100%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
margin-bottom: 4px;
}

.version {
font-size: 0.7rem;
color: #9b9b9b;
letter-spacing: 0.1em;
}

.date-display {
font-size: 0.9rem;
color: #6b6b6b;
margin-top: 4px;
}

/* ========================================
ã‚·ãƒ•ãƒˆé¸æŠç”»é¢
======================================== */
.shift-select-screen {
padding: 40px 0;
}

.shift-buttons {
display: flex;
flex-direction: column;
gap: 12px;
}

.shift-btn {
padding: 20px 24px;
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 12px;
font-size: 1rem;
font-weight: 500;
cursor: pointer;
text-align: left;
display: flex;
justify-content: space-between;
align-items: center;
transition: transform 0.1s, background 0.1s;
}

.shift-btn:active {
transform: scale(0.98);
background: #E8F5E9;
}

.shift-btn .time {
font-size: 0.85rem;
color: #6b6b6b;
font-weight: 400;
}

.add-shift-btn {
padding: 16px 24px;
background: #E8F5E9;
border: 2px dashed #4CAF50;
border-radius: 12px;
font-size: 1rem;
font-weight: 500;
cursor: pointer;
text-align: center;
color: #2E7D32;
transition: transform 0.1s, background 0.1s;
margin-top: 8px;
}

.add-shift-btn:active {
transform: scale(0.98);
background: #C8E6C9;
}

.manage-shifts-btn {
padding: 12px 24px;
background: transparent;
border: 1px solid #D4CFC5;
border-radius: 8px;
font-size: 0.9rem;
cursor: pointer;
text-align: center;
color: #6b6b6b;
margin-top: 20px;
width: 100%;
}

/* ========================================
ãƒ¡ã‚¤ãƒ³ç”»é¢
======================================== */
.main-screen {
display: none;
}

.main-screen.active {
display: block;
}

.shift-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
padding-bottom: 16px;
border-bottom: 1px solid #E5E2DC;
}

.current-shift {
font-size: 1.2rem;
font-weight: 600;
}

.current-shift-time {
font-size: 0.85rem;
color: #6b6b6b;
font-weight: 400;
margin-left: 8px;
}

.change-btn {
padding: 8px 16px;
background: transparent;
border: 1px solid #D4CFC5;
border-radius: 8px;
font-size: 0.85rem;
color: #6b6b6b;
cursor: pointer;
}

/* ========================================
ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
======================================== */
.progress-section {
margin-bottom: 24px;
background: #fff;
padding: 15px;
border-radius: 12px;
border: 1px solid #E5E2DC;
}

.progress-bar {
height: 6px;
background: #E8E4DB;
border-radius: 3px;
overflow: hidden;
margin-bottom: 8px;
}

.progress-fill {
height: 100%;
background: linear-gradient(90deg, #2E7D32, #4CAF50);
transition: width 0.3s ease;
}

.progress-text {
font-size: 0.85rem;
color: #6b6b6b;
text-align: right;
font-weight: 600;
}

/* ========================================
ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
======================================== */
.checklist {
display: flex;
flex-direction: column;
gap: 8px;
}

.checklist-item {
display: flex;
align-items: center;
padding: 16px;
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 10px;
gap: 12px;
transition: background 0.2s, border-color 0.2s;
cursor: pointer;
-webkit-user-select: none;
user-select: none;
}

.checklist-item.checked {
background: #E8F5E9;
border-color: #C8E6C9;
}

.checklist-item .item-text {
flex: 1;
font-size: 0.95rem;
}

.checklist-item.checked .item-text {
color: #558B2F;
text-decoration: line-through;
}

.custom-checkbox {
position: relative;
width: 24px;
height: 24px;
flex-shrink: 0;
}

.custom-checkbox input {
position: absolute;
opacity: 0;
width: 100%;
height: 100%;
cursor: pointer;
z-index: 2;
margin: 0;
}

.checkmark {
position: absolute;
top: 0;
left: 0;
width: 24px;
height: 24px;
background: #fff;
border: 2px solid #D4CFC5;
border-radius: 6px;
pointer-events: none;
}

.custom-checkbox input:checked + .checkmark {
background: #2E7D32;
border-color: #2E7D32;
}

.custom-checkbox input:checked + .checkmark::after {
content: â€˜â€™;
position: absolute;
left: 7px;
top: 3px;
width: 6px;
height: 11px;
border: solid white;
border-width: 0 2px 2px 0;
transform: rotate(45deg);
}

.day-badge {
font-size: 0.75rem;
padding: 2px 8px;
background: #E8E4DB;
color: #6b6b6b;
border-radius: 4px;
margin-left: 8px;
white-space: nowrap;
flex-shrink: 0;
}

/* ========================================
ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ–
======================================== */
.nav-tabs {
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: #fff;
border-top: 1px solid #E5E2DC;
display: flex;
justify-content: space-around;
padding: 12px 0;
z-index: 100;
padding-bottom: calc(12px + env(safe-area-inset-bottom));
}

.tab {
padding: 8px 20px;
background: transparent;
border: none;
font-size: 0.9rem;
color: #9b9b9b;
border-radius: 8px;
cursor: pointer;
}

.tab.active {
background: #E8F5E9;
color: #2E7D32;
font-weight: 600;
}

/* ========================================
ãƒ‘ãƒãƒ«
======================================== */
.panel {
display: none;
}

.panel.active {
display: block;
}

/* ========================================
ç·¨é›†ç”»é¢
======================================== */
.edit-shift-tabs {
display: flex;
gap: 8px;
margin-bottom: 20px;
flex-wrap: wrap;
}

.edit-shift-tab {
padding: 8px 16px;
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 8px;
font-size: 0.85rem;
color: #6b6b6b;
cursor: pointer;
}

.edit-shift-tab.active {
background: #2E7D32;
color: #fff;
border-color: #2E7D32;
}

.add-item-section {
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 12px;
padding: 16px;
margin-bottom: 20px;
}

.add-item-section input[type=â€œtextâ€] {
width: 100%;
padding: 12px;
border: 1px solid #E5E2DC;
border-radius: 8px;
font-size: 16px;
margin-bottom: 12px;
}

.day-select {
display: flex;
flex-wrap: wrap;
gap: 8px;
margin-bottom: 12px;
}

.day-select label {
display: flex;
align-items: center;
gap: 4px;
padding: 6px 12px;
background: #E8F5E9;
border-radius: 6px;
font-size: 0.85rem;
cursor: pointer;
}

.day-select input {
display: none;
}

.day-select input:checked + span {
color: #2E7D32;
font-weight: 600;
}

.date-input-row {
display: flex;
align-items: center;
gap: 8px;
margin-bottom: 12px;
font-size: 0.9rem;
color: #6b6b6b;
}

.date-input-row input {
width: 60px;
padding: 8px;
border: 1px solid #E5E2DC;
border-radius: 6px;
font-size: 16px;
}

.add-btn {
width: 100%;
padding: 12px;
background: #2E7D32;
color: #fff;
border: none;
border-radius: 8px;
font-size: 0.9rem;
font-weight: 500;
cursor: pointer;
}

.edit-list {
list-style: none;
}

.edit-list-item {
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 10px;
padding: 15px;
margin-bottom: 10px;
}

.edit-item-top {
display: flex;
justify-content: space-between;
align-items: flex-start;
gap: 10px;
}

.edit-item-top .item-text {
flex: 1;
font-size: 0.95rem;
word-break: break-word;
}

.edit-item-bottom {
display: flex;
gap: 8px;
margin-top: 12px;
padding-top: 12px;
border-top: 1px solid #eee;
flex-wrap: wrap;
}

.move-group {
display: flex;
gap: 4px;
}

.action-group {
display: flex;
gap: 8px;
margin-left: auto;
}

.move-btn,
.edit-btn {
background: #E8E4DB;
color: #6b6b6b;
border: none;
padding: 8px 12px;
border-radius: 6px;
font-size: 0.8rem;
cursor: pointer;
}

.delete-btn {
color: #C53030;
background: #FEE;
border: none;
padding: 8px 12px;
border-radius: 6px;
font-size: 0.8rem;
cursor: pointer;
}

/* ========================================
å®Œäº†ãƒœã‚¿ãƒ³
======================================== */
.complete-btn {
width: 100%;
padding: 18px;
background: linear-gradient(135deg, #2E7D32, #4CAF50);
color: #fff;
border: none;
border-radius: 12px;
font-size: 1rem;
font-weight: 600;
margin-top: 20px;
cursor: pointer;
transition: transform 0.1s;
}

.complete-btn:disabled {
background: #E8E4DB;
color: #9b9b9b;
cursor: not-allowed;
}

.complete-btn:not(:disabled):active {
transform: scale(0.98);
}

/* ========================================
å®Œäº†æ¸ˆã¿è¡¨ç¤º
======================================== */
.already-completed {
background: #E8F5E9;
padding: 20px;
border-radius: 10px;
text-align: center;
margin-bottom: 15px;
}

.undo-btn {
margin-top: 12px;
font-size: 0.85rem;
background: #fff;
border: 1px solid #ccc;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
}

/* ========================================
å±¥æ­´ç”»é¢
======================================== */
.history-item {
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 10px;
padding: 15px;
margin-bottom: 10px;
}

.history-date {
font-weight: 600;
margin-bottom: 4px;
}

.history-shift {
font-size: 0.85rem;
color: #6b6b6b;
margin-bottom: 8px;
}

.history-status {
display: flex;
align-items: center;
gap: 10px;
}

.badge {
padding: 4px 10px;
border-radius: 4px;
font-size: 0.8rem;
font-weight: 500;
}

.badge.complete {
background: #C8E6C9;
color: #2E7D32;
}

.badge.incomplete {
background: #FFF3CD;
color: #856404;
}

.history-meta {
font-size: 0.8rem;
color: #9b9b9b;
}

.history-details {
margin-top: 10px;
}

.history-details summary {
font-size: 0.85rem;
color: #6b6b6b;
cursor: pointer;
}

.history-details ul {
margin-top: 8px;
padding-left: 20px;
}

.history-details li {
font-size: 0.85rem;
color: #6b6b6b;
margin-bottom: 2px;
}

.history-details li.checked {
color: #2E7D32;
}

.no-history {
text-align: center;
color: #9b9b9b;
padding: 40px 0;
}

.backup-section {
background: #E8F5E9;
border: 1px solid #C8E6C9;
border-radius: 10px;
padding: 16px;
margin-top: 20px;
}

.backup-section h4 {
font-size: 0.9rem;
margin-bottom: 12px;
}

.backup-buttons {
display: flex;
flex-direction: column;
gap: 8px;
}

.backup-btn,
.restore-btn {
padding: 12px;
border: 1px solid #C8E6C9;
border-radius: 8px;
font-size: 0.85rem;
cursor: pointer;
text-align: center;
}

.backup-btn {
background: #fff;
}

.restore-btn {
background: #E8E4DB;
}

.reset-btn {
width: 100%;
padding: 14px;
background: transparent;
color: #C53030;
border: 1px solid #FCC;
border-radius: 8px;
font-size: 0.9rem;
cursor: pointer;
margin-top: 20px;
}

/* ========================================
ãƒ¢ãƒ¼ãƒ€ãƒ«
======================================== */
.modal-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.5);
z-index: 200;
align-items: center;
justify-content: center;
padding: 20px;
}

.modal-overlay.show {
display: flex;
}

.modal {
background: #fff;
border-radius: 16px;
padding: 24px;
width: 100%;
max-width: 400px;
max-height: 90vh;
overflow-y: auto;
}

.modal h3 {
margin-bottom: 16px;
}

.modal input[type=â€œtextâ€],
.modal input[type=â€œtimeâ€] {
width: 100%;
padding: 12px;
border: 1px solid #E5E2DC;
border-radius: 8px;
font-size: 16px;
margin-bottom: 12px;
}

.modal-buttons {
display: flex;
gap: 12px;
margin-top: 16px;
}

.modal-cancel,
.modal-confirm {
flex: 1;
padding: 12px;
border-radius: 8px;
font-size: 0.9rem;
font-weight: 500;
cursor: pointer;
border: none;
}

.modal-cancel {
background: #E8E4DB;
color: #6b6b6b;
}

.modal-confirm {
background: #2E7D32;
color: #fff;
}

.modal-danger {
background: #C53030;
color: #fff;
}

/* ========================================
ã‚·ãƒ•ãƒˆç®¡ç†
======================================== */
.shift-manage-list {
list-style: none;
margin-bottom: 16px;
}

.shift-manage-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 12px;
background: #fff;
border: 1px solid #E5E2DC;
border-radius: 8px;
margin-bottom: 8px;
}

.shift-manage-item .shift-info {
flex: 1;
}

.shift-manage-item .shift-name {
font-weight: 500;
}

.shift-manage-item .shift-time {
font-size: 0.85rem;
color: #6b6b6b;
}

.shift-manage-item .shift-actions {
display: flex;
gap: 8px;
}

.shift-edit-btn,
.shift-delete-btn {
padding: 6px 12px;
border: none;
border-radius: 6px;
font-size: 0.8rem;
cursor: pointer;
}

.shift-edit-btn {
background: #E8E4DB;
color: #6b6b6b;
}

.shift-delete-btn {
background: #FEE;
color: #C53030;
}

/* ========================================
å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
======================================== */
.completion-message {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: #FAF9F6;
z-index: 300;
justify-content: center;
align-items: center;
flex-direction: column;
}

.completion-message.show {
display: flex;
animation: fadeIn 0.3s;
}

.completion-message .icon {
font-size: 64px;
color: #2E7D32;
margin-bottom: 20px;
}

.completion-message h2 {
margin-bottom: 8px;
}

.completion-message p {
color: #6b6b6b;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

/* ç©ºçŠ¶æ…‹ */
.empty-state {
text-align: center;
padding: 40px 20px;
color: #9b9b9b;
}

.empty-state p {
margin-bottom: 16px;
}
</style>

</head>
<body>

<header>
  <h1>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æ¥­å‹™</h1>
  <div class="version">ver 2026.01.29</div>
  <div class="date-display" id="dateDisplay"></div>
</header>

<div class="container">
  <!-- ã‚·ãƒ•ãƒˆé¸æŠç”»é¢ -->
  <div id="shiftSelectScreen" class="shift-select-screen">
    <h2 style="text-align:center; margin-bottom:24px; font-size:1.1rem;">ã‚·ãƒ•ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
    <div id="shiftButtons" class="shift-buttons"></div>
    <button class="add-shift-btn" id="addShiftBtn">ï¼‹ æ–°ã—ã„ã‚·ãƒ•ãƒˆã‚’è¿½åŠ </button>
    <button class="manage-shifts-btn" id="manageShiftsBtn">ã‚·ãƒ•ãƒˆã‚’ç®¡ç†</button>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->

  <div id="mainScreen" class="main-screen">
    <div class="nav-tabs">
      <button class="tab active" data-tab="check">ãƒã‚§ãƒƒã‚¯</button>
      <button class="tab" data-tab="edit">é …ç›®ç·¨é›†</button>
      <button class="tab" data-tab="history">å±¥æ­´</button>
    </div>

```
<!-- ãƒã‚§ãƒƒã‚¯ãƒ‘ãƒãƒ« -->
<div id="checkPanel" class="panel active">
  <div class="shift-header">
    <span>
      <span class="current-shift" id="currentShiftName"></span>
      <span class="current-shift-time" id="currentShiftTime"></span>
    </span>
    <button class="change-btn" id="changeShiftBtn">å¤‰æ›´</button>
  </div>
  <div id="alreadyCompleted" class="already-completed" style="display:none;">
    âœ“ æœ¬æ—¥ã®æ¥­å‹™ã¯å®Œäº†ã—ã¦ã„ã¾ã™<br>
    <span style="font-size:0.85rem; color:#666;">æ˜æ—¥ã«ãªã‚‹ã¨ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</span>
    <br>
    <button class="undo-btn" id="undoCompleteBtn">ä¿®æ­£ã™ã‚‹</button>
  </div>
  <div class="progress-section" id="progressSection">
    <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>
    <div id="progressText" class="progress-text">0/0</div>
  </div>
  <div id="checklist" class="checklist"></div>
  <button id="completeBtn" class="complete-btn" disabled>å®Œäº†</button>
</div>

<!-- ç·¨é›†ãƒ‘ãƒãƒ« -->
<div id="editPanel" class="panel">
  <div id="editShiftTabs" class="edit-shift-tabs"></div>
  <div class="add-item-section">
    <input type="text" id="newItemText" placeholder="æ–°ã—ã„é …ç›®ã‚’å…¥åŠ›...">
    <div class="day-select" id="newItemDays">
      <label><input type="checkbox" value="æ¯æ—¥" checked><span>æ¯æ—¥</span></label>
      <label><input type="checkbox" value="æœˆ"><span>æœˆ</span></label>
      <label><input type="checkbox" value="ç«"><span>ç«</span></label>
      <label><input type="checkbox" value="æ°´"><span>æ°´</span></label>
      <label><input type="checkbox" value="æœ¨"><span>æœ¨</span></label>
      <label><input type="checkbox" value="é‡‘"><span>é‡‘</span></label>
      <label><input type="checkbox" value="åœŸ"><span>åœŸ</span></label>
      <label><input type="checkbox" value="æ—¥"><span>æ—¥</span></label>
    </div>
    <div class="date-input-row">
      <span>ç‰¹å®šæ—¥ï¼ˆæ¯æœˆï¼‰:</span>
      <input type="number" id="newItemDate" min="1" max="31" placeholder="-">
      <span>æ—¥</span>
    </div>
    <button class="add-btn" id="addItemBtn">è¿½åŠ </button>
  </div>
  <h3 style="margin-bottom:12px; font-size:1rem;">é …ç›®ä¸€è¦§</h3>
  <ul id="editList" class="edit-list"></ul>
</div>

<!-- å±¥æ­´ãƒ‘ãƒãƒ« -->
<div id="historyPanel" class="panel">
  <div id="historyList"></div>
  <div class="backup-section">
    <h4>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ</h4>
    <div class="backup-buttons">
      <button class="backup-btn" id="exportBackupBtn">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="restore-btn" id="showRestoreBtn">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</button>
    </div>
  </div>
  <button class="reset-btn" id="resetHistoryBtn">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
</div>
```

  </div>
</div>

<!-- ã‚·ãƒ•ãƒˆè¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->

<div id="shiftModal" class="modal-overlay">
  <div class="modal">
    <h3 id="shiftModalTitle">ã‚·ãƒ•ãƒˆã‚’è¿½åŠ </h3>
    <input type="text" id="shiftNameInput" placeholder="ã‚·ãƒ•ãƒˆåï¼ˆä¾‹ï¼šæ—©ç•ªï¼‰">
    <div style="display:flex; gap:12px;">
      <div style="flex:1;">
        <label style="font-size:0.85rem; color:#6b6b6b; display:block; margin-bottom:4px;">é–‹å§‹æ™‚é–“</label>
        <input type="time" id="shiftStartInput">
      </div>
      <div style="flex:1;">
        <label style="font-size:0.85rem; color:#6b6b6b; display:block; margin-bottom:4px;">çµ‚äº†æ™‚é–“</label>
        <input type="time" id="shiftEndInput">
      </div>
    </div>
    <div class="modal-buttons">
      <button class="modal-cancel" id="shiftModalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-confirm" id="shiftModalConfirm">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ã‚·ãƒ•ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->

<div id="manageShiftsModal" class="modal-overlay">
  <div class="modal">
    <h3>ã‚·ãƒ•ãƒˆç®¡ç†</h3>
    <ul id="shiftManageList" class="shift-manage-list"></ul>
    <div class="modal-buttons">
      <button class="modal-cancel" id="manageShiftsClose" style="flex:1;">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- é …ç›®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->

<div id="editModal" class="modal-overlay">
  <div class="modal">
    <h3>é …ç›®ã‚’ç·¨é›†</h3>
    <input type="text" id="editItemInput">
    <div class="day-select" id="editItemDays"></div>
    <div class="date-input-row">
      <span>ç‰¹å®šæ—¥:</span>
      <input type="number" id="editItemDate" min="1" max="31" placeholder="-">
      <span>æ—¥</span>
    </div>
    <div class="modal-buttons">
      <button class="modal-cancel" id="editModalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-confirm" id="editModalConfirm">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->

<div id="deleteConfirmModal" class="modal-overlay">
  <div class="modal">
    <h3>âš ï¸ ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤</h3>
    <p id="deleteConfirmText" style="margin-bottom:16px; color:#666;"></p>
    <div class="modal-buttons">
      <button class="modal-cancel" id="deleteConfirmCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-confirm modal-danger" id="deleteConfirmOk">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->

<div id="completionMessage" class="completion-message">
  <div class="icon">âœ“</div>
  <h2>å®Œäº†ã—ã¾ã—ãŸ</h2>
  <p>ãŠç–²ã‚Œæ§˜ã§ã—ãŸ</p>
</div>

<script>
(function() {
  'use strict';

  var STORAGE_KEYS = {
    shifts: 'routine_shifts_v1',
    items: 'routine_items_v1',
    todayChecks: 'routine_checks_v1',
    history: 'routine_hist_v1',
    currentShift: 'routine_shift',
    lastDate: 'routine_date'
  };

  var DAY_NAMES = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  var BACKUP_VERSION = '2026.01.29';

  var state = {
    shifts: [],
    items: {},
    todayChecks: {},
    history: [],
    currentShift: null,
    editingShift: null,
    editingIndex: -1,
    editingShiftId: null
  };

  function generateId() {
    return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
  }

  function getTodayKey() {
    var d = new Date();
    return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
  }

  function getTodayString() {
    return new Date().toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'long'
    });
  }

  function getTodayDayName() {
    return DAY_NAMES[new Date().getDay()];
  }

  function getTodayDate() {
    return new Date().getDate();
  }

  function getLastDayOfMonth() {
    var now = new Date();
    return new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  }

  function formatTime(time) {
    if (!time) return '';
    return time;
  }

  function getShiftById(shiftId) {
    return state.shifts.find(function(s) { return s.id === shiftId; });
  }

  function getShiftTimeString(shift) {
    if (!shift) return '';
    if (shift.startTime && shift.endTime) {
      return shift.startTime + ' - ' + shift.endTime;
    }
    return '';
  }

  function loadFromStorage(key, defaultValue) {
    try {
      var data = localStorage.getItem(key);
      if (data === null || data === undefined) {
        return defaultValue;
      }
      var parsed = JSON.parse(data);
      return (parsed !== null && parsed !== undefined) ? parsed : defaultValue;
    } catch (e) {
      console.warn('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', key, e);
      return defaultValue;
    }
  }

  function saveToStorage(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (e) {
      console.error('localStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', key, e);
      if (e.name === 'QuotaExceededError') {
        alert('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚');
      }
      return false;
    }
  }

  function shouldShowItem(item) {
    var todayDate = getTodayDate();
    var todayDayName = getTodayDayName();

    if (item.date !== null && item.date !== undefined && item.date !== '') {
      var targetDate = parseInt(item.date, 10);
      if (isNaN(targetDate) || targetDate < 1 || targetDate > 31) {
        return false;
      }
      if (targetDate === todayDate) {
        return true;
      }
      var lastDay = getLastDayOfMonth();
      if (todayDate === lastDay && targetDate > lastDay) {
        return true;
      }
      return false;
    }

    var days = item.days;
    if (!days || !Array.isArray(days) || days.length === 0) {
      return true;
    }
    if (days.indexOf('æ¯æ—¥') !== -1) {
      return true;
    }
    if (days.indexOf(todayDayName) !== -1) {
      return true;
    }
    return false;
  }

  function getItemDayLabel(item) {
    if (item.date) {
      return item.date + 'æ—¥';
    }
    if (item.days && item.days.length > 0 && item.days.indexOf('æ¯æ—¥') === -1) {
      return item.days.join('ãƒ»');
    }
    return '';
  }

  function getCheckKey(shiftId, itemId) {
    return getTodayKey() + '_' + shiftId + '_' + itemId;
  }

  function isItemChecked(itemId) {
    var key = getCheckKey(state.currentShift, itemId);
    return !!state.todayChecks[key];
  }

  function toggleItemCheck(itemId) {
    var key = getCheckKey(state.currentShift, itemId);
    state.todayChecks[key] = !state.todayChecks[key];
    saveToStorage(STORAGE_KEYS.todayChecks, state.todayChecks);
    
    if (window.navigator && window.navigator.vibrate) {
      try { window.navigator.vibrate(10); } catch (e) {}
    }
    
    var itemElement = document.querySelector('.checklist-item[data-id="' + itemId + '"]');
    if (itemElement) {
      itemElement.classList.add('pop-animation');
      setTimeout(function() {
        itemElement.classList.remove('pop-animation');
      }, 300);
    }
    
    renderChecklist();
    updateProgress();
  }

  function getVisibleItems() {
    if (!state.currentShift || !state.items[state.currentShift]) {
      return [];
    }
    return state.items[state.currentShift].filter(shouldShowItem);
  }

  function canComplete() {
    var visible = getVisibleItems();
    if (visible.length === 0) {
      return false;
    }
    return visible.every(function(item) {
      return isItemChecked(item.id);
    });
  }

  function checkDateChange() {
    var lastDate = localStorage.getItem(STORAGE_KEYS.lastDate);
    var today = getTodayKey();
    if (lastDate !== today) {
      localStorage.setItem(STORAGE_KEYS.lastDate, today);
      state.todayChecks = {};
      saveToStorage(STORAGE_KEYS.todayChecks, state.todayChecks);
      return true;
    }
    return false;
  }

  function isAlreadyCompleted() {
    var todayKey = getTodayKey();
    return state.history.some(function(record) {
      return record.dateKey === todayKey &&
             record.shiftId === state.currentShift &&
             record.allChecked === true;
    });
  }

  function completeCheck() {
    if (!canComplete()) return;

    var todayKey = getTodayKey();
    var now = new Date();
    var visible = getVisibleItems();
    var shift = getShiftById(state.currentShift);

    var checkedItems = {};
    visible.forEach(function(item) {
      checkedItems[item.id] = {
        text: item.text,
        checked: isItemChecked(item.id)
      };
    });

    var record = {
      dateKey: todayKey,
      date: getTodayString(),
      shiftId: state.currentShift,
      shiftName: shift ? shift.name : 'ä¸æ˜',
      time: now.getHours() + ':' + ('0' + now.getMinutes()).slice(-2),
      checkedItems: checkedItems,
      allChecked: true
    };

    state.history.unshift(record);
    if (state.history.length > 100) {
      state.history = state.history.slice(0, 100);
    }
    saveToStorage(STORAGE_KEYS.history, state.history);
    showCompletionMessage();
  }

  function undoComplete() {
    var todayKey = getTodayKey();
    state.history = state.history.filter(function(record) {
      return !(record.dateKey === todayKey && record.shiftId === state.currentShift);
    });
    saveToStorage(STORAGE_KEYS.history, state.history);
    renderChecklist();
    updateProgress();
    updateCompletedState();
    renderHistory();
  }

  function showCompletionMessage() {
    var msg = document.getElementById('completionMessage');
    msg.classList.add('show');
    setTimeout(function() {
      msg.classList.remove('show');
      updateCompletedState();
      renderHistory();
    }, 1500);
  }

  function renderShiftButtons() {
    var container = document.getElementById('shiftButtons');
    container.innerHTML = '';

    if (state.shifts.length === 0) {
      container.innerHTML = '<div class="empty-state"><p>ã‚·ãƒ•ãƒˆãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p><p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p></div>';
      return;
    }

    state.shifts.forEach(function(shift) {
      var btn = document.createElement('button');
      btn.className = 'shift-btn';
      btn.setAttribute('data-shift-id', shift.id);
      
      var nameSpan = document.createElement('span');
      nameSpan.textContent = shift.name;
      
      var timeSpan = document.createElement('span');
      timeSpan.className = 'time';
      timeSpan.textContent = getShiftTimeString(shift);
      
      btn.appendChild(nameSpan);
      btn.appendChild(timeSpan);
      
      btn.addEventListener('click', function() {
        selectShift(shift.id);
      });
      
      container.appendChild(btn);
    });
  }

  function renderChecklist() {
    var container = document.getElementById('checklist');
    container.innerHTML = '';

    var visible = getVisibleItems();

    if (visible.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:#9b9b9b; padding:20px;">æœ¬æ—¥ã®ãƒã‚§ãƒƒã‚¯é …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
      return;
    }

    visible.forEach(function(item) {
      var checked = isItemChecked(item.id);
      var dayLabel = getItemDayLabel(item);

      var div = document.createElement('div');
      div.className = 'checklist-item' + (checked ? ' checked' : '');
      div.setAttribute('data-id', item.id);

      var checkboxDiv = document.createElement('div');
      checkboxDiv.className = 'custom-checkbox';
      
      var input = document.createElement('input');
      input.type = 'checkbox';
      input.checked = checked;
      input.setAttribute('data-id', item.id);
      input.addEventListener('click', function(e) {
        e.stopPropagation();
      });
      input.addEventListener('change', function(e) {
        toggleItemCheck(e.target.getAttribute('data-id'));
      });

      var checkmark = document.createElement('span');
      checkmark.className = 'checkmark';

      checkboxDiv.appendChild(input);
      checkboxDiv.appendChild(checkmark);

      var textSpan = document.createElement('span');
      textSpan.className = 'item-text';
      textSpan.textContent = item.text;

      div.appendChild(checkboxDiv);
      div.appendChild(textSpan);

      if (dayLabel) {
        var badge = document.createElement('span');
        badge.className = 'day-badge';
        badge.textContent = dayLabel;
        div.appendChild(badge);
      }

      div.addEventListener('click', function(e) {
        if (e.target.tagName === 'INPUT') return;
        var itemId = this.getAttribute('data-id');
        toggleItemCheck(itemId);
      });

      container.appendChild(div);
    });

    updateCompletedState();
  }

  function updateProgress() {
    var visible = getVisibleItems();
    var total = visible.length;
    var checked = visible.filter(function(item) {
      return isItemChecked(item.id);
    }).length;

    var percent = total > 0 ? (checked / total) * 100 : 0;

    document.getElementById('progressFill').style.width = percent + '%';
    document.getElementById('progressText').textContent = checked + '/' + total;
    document.getElementById('completeBtn').disabled = !canComplete();
  }

  function updateCompletedState() {
    var completed = isAlreadyCompleted();
    var alreadyMsg = document.getElementById('alreadyCompleted');
    var checklist = document.getElementById('checklist');
    var progressSection = document.getElementById('progressSection');
    var completeBtn = document.getElementById('completeBtn');

    if (completed) {
      alreadyMsg.style.display = 'block';
      checklist.style.display = 'none';
      progressSection.style.display = 'none';
      completeBtn.style.display = 'none';
    } else {
      alreadyMsg.style.display = 'none';
      checklist.style.display = 'flex';
      progressSection.style.display = 'block';
      completeBtn.style.display = 'block';
    }
  }

  function renderEditShiftTabs() {
    var container = document.getElementById('editShiftTabs');
    container.innerHTML = '';

    if (state.shifts.length === 0) {
      container.innerHTML = '<p style="color:#9b9b9b; font-size:0.9rem;">ã‚·ãƒ•ãƒˆã‚’å…ˆã«è¿½åŠ ã—ã¦ãã ã•ã„</p>';
      return;
    }

    state.shifts.forEach(function(shift) {
      var btn = document.createElement('button');
      btn.className = 'edit-shift-tab' + (shift.id === state.editingShift ? ' active' : '');
      btn.textContent = shift.name;
      btn.addEventListener('click', function() {
        state.editingShift = shift.id;
        renderEditShiftTabs();
        renderEditList();
      });
      container.appendChild(btn);
    });
  }

  function renderEditList() {
    var container = document.getElementById('editList');
    container.innerHTML = '';

    if (!state.editingShift || !state.items[state.editingShift]) {
      if (state.shifts.length > 0) {
        container.innerHTML = '<p style="text-align:center; color:#9b9b9b; padding:20px;">é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>';
      }
      return;
    }

    var shiftItems = state.items[state.editingShift];

    if (shiftItems.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:#9b9b9b; padding:20px;">é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>';
      return;
    }

    shiftItems.forEach(function(item, index) {
      var dayLabel = '';
      if (item.date) {
        dayLabel = 'æ¯æœˆ' + item.date + 'æ—¥';
      } else if (item.days && item.days.length > 0) {
        dayLabel = item.days.join('ãƒ»');
      }

      var li = document.createElement('li');
      li.className = 'edit-list-item';

      var topDiv = document.createElement('div');
      topDiv.className = 'edit-item-top';
      
      var textSpan = document.createElement('span');
      textSpan.className = 'item-text';
      textSpan.textContent = item.text;
      topDiv.appendChild(textSpan);

      if (dayLabel) {
        var badge = document.createElement('span');
        badge.className = 'day-badge';
        badge.textContent = dayLabel;
        topDiv.appendChild(badge);
      }

      var bottomDiv = document.createElement('div');
      bottomDiv.className = 'edit-item-bottom';

      var moveGroup = document.createElement('div');
      moveGroup.className = 'move-group';

      var upBtn = document.createElement('button');
      upBtn.className = 'move-btn';
      upBtn.textContent = 'â†‘ä¸Šã¸';
      upBtn.addEventListener('click', function() { moveItem(index, -1); });

      var downBtn = document.createElement('button');
      downBtn.className = 'move-btn';
      downBtn.textContent = 'â†“ä¸‹ã¸';
      downBtn.addEventListener('click', function() { moveItem(index, 1); });

      moveGroup.appendChild(upBtn);
      moveGroup.appendChild(downBtn);

      var actionGroup = document.createElement('div');
      actionGroup.className = 'action-group';

      var editBtn = document.createElement('button');
      editBtn.className = 'edit-btn';
      editBtn.textContent = 'ç·¨é›†';
      editBtn.addEventListener('click', function() { openEditModal(index); });

      var deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = 'å‰Šé™¤';
      deleteBtn.addEventListener('click', function() { deleteItem(index); });

      actionGroup.appendChild(editBtn);
      actionGroup.appendChild(deleteBtn);

      bottomDiv.appendChild(moveGroup);
      bottomDiv.appendChild(actionGroup);

      li.appendChild(topDiv);
      li.appendChild(bottomDiv);
      container.appendChild(li);
    });
  }

  function renderHistory() {
    var container = document.getElementById('historyList');

    if (state.history.length === 0) {
      container.innerHTML = '<div class="no-history">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    var html = '';
    var displayHistory = state.history.slice(0, 50);

    displayHistory.forEach(function(record) {
      var checkedItems = record.checkedItems || {};
      var ids = Object.keys(checkedItems);
      var totalCount = ids.length;
      var checkedCount = ids.filter(function(id) {
        return checkedItems[id].checked;
      }).length;

      var itemsHtml = ids.map(function(id) {
        var item = checkedItems[id];
        var isChecked = item.checked;
        return '<li class="' + (isChecked ? 'checked' : '') + '">' +
               (isChecked ? 'âœ“ ' : 'âˆ’ ') + item.text + '</li>';
      }).join('');

      var shiftName = record.shiftName || record.shift || 'ä¸æ˜';

      html += '<div class="history-item">' +
              '<div class="history-date">' + record.date + '</div>' +
              '<div class="history-shift">' + shiftName + '</div>' +
              '<div class="history-status">' +
              '<span class="badge ' + (record.allChecked ? 'complete' : 'incomplete') + '">' +
              (record.allChecked ? 'å®Œäº†' : 'æœªå®Œäº†') + '</span>' +
              '<span class="history-meta">' + checkedCount + '/' + totalCount + ' â€¢ ' + record.time + '</span>' +
              '</div>' +
              '<details class="history-details">' +
              '<summary>è©³ç´°ã‚’è¡¨ç¤º</summary>' +
              '<ul>' + itemsHtml + '</ul>' +
              '</details>' +
              '</div>';
    });

    container.innerHTML = html;
  }

  function renderShiftManageList() {
    var container = document.getElementById('shiftManageList');
    container.innerHTML = '';

    if (state.shifts.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:#9b9b9b; padding:20px;">ã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
      return;
    }

    state.shifts.forEach(function(shift) {
      var li = document.createElement('li');
      li.className = 'shift-manage-item';

      var infoDiv = document.createElement('div');
      infoDiv.className = 'shift-info';

      var nameSpan = document.createElement('div');
      nameSpan.className = 'shift-name';
      nameSpan.textContent = shift.name;

      var timeSpan = document.createElement('div');
      timeSpan.className = 'shift-time';
      timeSpan.textContent = getShiftTimeString(shift);

      infoDiv.appendChild(nameSpan);
      infoDiv.appendChild(timeSpan);

      var actionsDiv = document.createElement('div');
      actionsDiv.className = 'shift-actions';

      var editBtn = document.createElement('button');
      editBtn.className = 'shift-edit-btn';
      editBtn.textContent = 'ç·¨é›†';
      editBtn.addEventListener('click', function() {
        openShiftEditModal(shift.id);
      });

      var deleteBtn = document.createElement('button');
      deleteBtn.className = 'shift-delete-btn';
      deleteBtn.textContent = 'å‰Šé™¤';
      deleteBtn.addEventListener('click', function() {
        openDeleteConfirmModal(shift.id);
      });

      actionsDiv.appendChild(editBtn);
      actionsDiv.appendChild(deleteBtn);

      li.appendChild(infoDiv);
      li.appendChild(actionsDiv);
      container.appendChild(li);
    });
  }

  function openShiftModal(editId) {
    state.editingShiftId = editId || null;
    var modal = document.getElementById('shiftModal');
    var title = document.getElementById('shiftModalTitle');
    var nameInput = document.getElementById('shiftNameInput');
    var startInput = document.getElementById('shiftStartInput');
    var endInput = document.getElementById('shiftEndInput');

    if (editId) {
      var shift = getShiftById(editId);
      title.textContent = 'ã‚·ãƒ•ãƒˆã‚’ç·¨é›†';
      nameInput.value = shift ? shift.name : '';
      startInput.value = shift ? shift.startTime : '';
      endInput.value = shift ? shift.endTime : '';
    } else {
      title.textContent = 'ã‚·ãƒ•ãƒˆã‚’è¿½åŠ ';
      nameInput.value = '';
      startInput.value = '';
      endInput.value = '';
    }

    modal.classList.add('show');
  }

  function closeShiftModal() {
    document.getElementById('shiftModal').classList.remove('show');
    state.editingShiftId = null;
  }

  function saveShift() {
    var nameInput = document.getElementById('shiftNameInput');
    var startInput = document.getElementById('shiftStartInput');
    var endInput = document.getElementById('shiftEndInput');

    var name = nameInput.value.trim();
    if (!name) {
      alert('ã‚·ãƒ•ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    if (state.editingShiftId) {
      var shift = getShiftById(state.editingShiftId);
      if (shift) {
        shift.name = name;
        shift.startTime = startInput.value;
        shift.endTime = endInput.value;
      }
    } else {
      var newShift = {
        id: generateId(),
        name: name,
        startTime: startInput.value,
        endTime: endInput.value
      };
      state.shifts.push(newShift);
      state.items[newShift.id] = [];
    }

    saveToStorage(STORAGE_KEYS.shifts, state.shifts);
    saveToStorage(STORAGE_KEYS.items, state.items);
    
    closeShiftModal();
    renderShiftButtons();
    renderEditShiftTabs();
    renderShiftManageList();
    
    if (!state.editingShift && state.shifts.length > 0) {
      state.editingShift = state.shifts[0].id;
      renderEditShiftTabs();
      renderEditList();
    }
  }

  function openShiftEditModal(shiftId) {
    document.getElementById('manageShiftsModal').classList.remove('show');
    openShiftModal(shiftId);
  }

  function openDeleteConfirmModal(shiftId) {
    var shift = getShiftById(shiftId);
    if (!shift) return;

    state.editingShiftId = shiftId;
    document.getElementById('deleteConfirmText').textContent = 
      'ã€Œ' + shift.name + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®ã‚·ãƒ•ãƒˆã®å…¨ã¦ã®é …ç›®ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚';
    document.getElementById('deleteConfirmModal').classList.add('show');
  }

  function closeDeleteConfirmModal() {
    document.getElementById('deleteConfirmModal').classList.remove('show');
    state.editingShiftId = null;
  }

  function deleteShift() {
    if (!state.editingShiftId) return;

    var shiftId = state.editingShiftId;
    state.shifts = state.shifts.filter(function(s) { return s.id !== shiftId; });
    delete state.items[shiftId];
    
    if (state.currentShift === shiftId) {
      state.currentShift = null;
      saveToStorage(STORAGE_KEYS.currentShift, null);
    }
    
    if (state.editingShift === shiftId) {
      state.editingShift = state.shifts.length > 0 ? state.shifts[0].id : null;
    }

    saveToStorage(STORAGE_KEYS.shifts, state.shifts);
    saveToStorage(STORAGE_KEYS.items, state.items);
    
    closeDeleteConfirmModal();
    renderShiftButtons();
    renderEditShiftTabs();
    renderEditList();
    renderShiftManageList();
  }

  function addItem() {
    if (!state.editingShift) {
      alert('ã‚·ãƒ•ãƒˆã‚’å…ˆã«è¿½åŠ ã—ã¦ãã ã•ã„');
      return;
    }

    var textInput = document.getElementById('newItemText');
    var text = textInput.value.trim();

    if (!text) {
      alert('é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    var days = getSelectedDays('newItemDays');
    var dateValue = document.getElementById('newItemDate').value;
    var date = dateValue ? parseInt(dateValue, 10) : null;

    if (date !== null && (isNaN(date) || date < 1 || date > 31)) {
      alert('ç‰¹å®šæ—¥ã¯1ã€œ31ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    if (date) {
      days = [];
    }

    if (!state.items[state.editingShift]) {
      state.items[state.editingShift] = [];
    }

    state.items[state.editingShift].push({
      id: generateId(),
      text: text,
      days: days,
      date: date
    });

    saveToStorage(STORAGE_KEYS.items, state.items);

    textInput.value = '';
    document.getElementById('newItemDate').value = '';
    resetDaySelect('newItemDays');

    renderEditList();

    if (state.editingShift === state.currentShift) {
      renderChecklist();
      updateProgress();
    }
  }

  function moveItem(index, direction) {
    var items = state.items[state.editingShift];
    var newIndex = index + direction;

    if (newIndex < 0 || newIndex >= items.length) {
      return;
    }

    var temp = items[index];
    items[index] = items[newIndex];
    items[newIndex] = temp;

    saveToStorage(STORAGE_KEYS.items, state.items);
    renderEditList();

    if (state.editingShift === state.currentShift) {
      renderChecklist();
    }
  }

  function deleteItem(index) {
    state.items[state.editingShift].splice(index, 1);
    saveToStorage(STORAGE_KEYS.items, state.items);
    renderEditList();

    if (state.editingShift === state.currentShift) {
      renderChecklist();
      updateProgress();
    }
  }

  function openEditModal(index) {
    state.editingIndex = index;
    var item = state.items[state.editingShift][index];

    document.getElementById('editItemInput').value = item.text;
    document.getElementById('editItemDate').value = item.date || '';

    var daysContainer = document.getElementById('editItemDays');
    var allDays = ['æ¯æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
    daysContainer.innerHTML = '';

    allDays.forEach(function(day) {
      var isChecked = item.days && item.days.indexOf(day) !== -1;
      var label = document.createElement('label');
      var input = document.createElement('input');
      input.type = 'checkbox';
      input.value = day;
      input.checked = isChecked;
      var span = document.createElement('span');
      span.textContent = day;
      label.appendChild(input);
      label.appendChild(span);
      daysContainer.appendChild(label);
    });

    setupDaySelectLogic('editItemDays');
    document.getElementById('editModal').classList.add('show');
  }

  function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
    state.editingIndex = -1;
  }

  function confirmEdit() {
    var text = document.getElementById('editItemInput').value.trim();

    if (!text) {
      alert('é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    var days = getSelectedDays('editItemDays');
    var dateValue = document.getElementById('editItemDate').value;
    var date = dateValue ? parseInt(dateValue, 10) : null;

    if (date !== null && (isNaN(date) || date < 1 || date > 31)) {
      alert('ç‰¹å®šæ—¥ã¯1ã€œ31ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    if (date) {
      days = [];
    }

    var item = state.items[state.editingShift][state.editingIndex];
    item.text = text;
    item.days = days;
    item.date = date;

    saveToStorage(STORAGE_KEYS.items, state.items);
    closeEditModal();
    renderEditList();

    if (state.editingShift === state.currentShift) {
      renderChecklist();
      updateProgress();
    }
  }

  function getSelectedDays(containerId) {
    var container = document.getElementById(containerId);
    var checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
    var days = [];
    checkboxes.forEach(function(cb) {
      days.push(cb.value);
    });
    return days;
  }

  function resetDaySelect(containerId) {
    var container = document.getElementById(containerId);
    var checkboxes = container.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(function(cb) {
      cb.checked = (cb.value === 'æ¯æ—¥');
    });
  }

  function setupDaySelectLogic(containerId) {
    var container = document.getElementById(containerId);
    if (!container) return;

    var checkboxes = container.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(function(cb) {
      cb.addEventListener('change', function() {
        if (this.value === 'æ¯æ—¥' && this.checked) {
          checkboxes.forEach(function(other) {
            if (other.value !== 'æ¯æ—¥') {
              other.checked = false;
            }
          });
        } else if (this.value !== 'æ¯æ—¥' && this.checked) {
          var everyday = container.querySelector('input[value="æ¯æ—¥"]');
          if (everyday) {
            everyday.checked = false;
          }
        }
      });
    });
  }

  function exportBackup() {
    var backup = {
      version: BACKUP_VERSION,
      exportDate: new Date().toISOString(),
      shifts: state.shifts || [],
      items: state.items || {},
      history: state.history || [],
      todayChecks: state.todayChecks || {},
      currentShift: state.currentShift || null
    };

    var text = JSON.stringify(backup);
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function() {
        showCopyNotification();
      }).catch(function() {});
    }

    var modal = document.createElement('div');
    modal.id = 'backupModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px;';

    var inner = document.createElement('div');
    inner.style.cssText = 'background:white;border-radius:12px;padding:20px;width:100%;max-height:80%;overflow:auto;';
    
    var textarea = document.createElement('textarea');
    textarea.id = 'backupTextArea';
    textarea.readOnly = true;
    textarea.style.cssText = 'width:100%;height:180px;font-size:11px;padding:8px;border:1px solid #ccc;border-radius:8px;background:#f9f9f9;-webkit-user-select:text;user-select:text;';
    textarea.value = text;
    
    var title = document.createElement('h3');
    title.style.marginBottom = '12px';
    title.textContent = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿';
    
    var desc = document.createElement('p');
    desc.style.cssText = 'font-size:0.85rem;color:#666;margin-bottom:12px;';
    desc.textContent = 'ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
    
    var copyBtn = document.createElement('button');
    copyBtn.style.cssText = 'width:100%;padding:14px;background:#4CAF50;color:white;border:none;border-radius:8px;font-weight:500;margin-top:12px;cursor:pointer;';
    copyBtn.textContent = 'ğŸ“‹ ã‚‚ã†ä¸€åº¦ã‚³ãƒ”ãƒ¼';
    copyBtn.onclick = function() {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
          showCopyNotification();
        });
      } else {
        textarea.select();
        document.execCommand('copy');
        showCopyNotification();
      }
    };
    
    var closeBtn = document.createElement('button');
    closeBtn.style.cssText = 'width:100%;padding:14px;background:#2E7D32;color:white;border:none;border-radius:8px;font-weight:500;margin-top:8px;cursor:pointer;';
    closeBtn.textContent = 'é–‰ã˜ã‚‹';
    closeBtn.onclick = function() { modal.remove(); };
    
    inner.appendChild(title);
    inner.appendChild(desc);
    inner.appendChild(textarea);
    inner.appendChild(copyBtn);
    inner.appendChild(closeBtn);
    modal.appendChild(inner);
    document.body.appendChild(modal);
    
    textarea.focus();
    textarea.select();
  }
  
  function showCopyNotification() {
    var notification = document.createElement('div');
    notification.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#4CAF50;color:white;padding:12px 24px;border-radius:8px;z-index:1000;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
    notification.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
    document.body.appendChild(notification);
    setTimeout(function() {
      notification.style.transition = 'opacity 0.3s';
      notification.style.opacity = '0';
      setTimeout(function() { notification.remove(); }, 300);
    }, 1500);
  }

  function showRestoreModal() {
    var modal = document.createElement('div');
    modal.id = 'restoreModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px;';

    var inner = document.createElement('div');
    inner.style.cssText = 'background:white;border-radius:12px;padding:20px;width:100%;max-width:500px;';
    
    var title = document.createElement('h3');
    title.style.marginBottom = '12px';
    title.textContent = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ';
    
    var desc = document.createElement('p');
    desc.style.cssText = 'font-size:0.85rem;color:#666;margin-bottom:12px;';
    desc.textContent = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„';
    
    var textarea = document.createElement('textarea');
    textarea.id = 'restoreTextArea';
    textarea.placeholder = 'ã“ã“ã«è²¼ã‚Šä»˜ã‘';
    textarea.style.cssText = 'width:100%;height:150px;font-size:11px;padding:8px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;';
    
    var btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display:flex;gap:8px;margin-top:12px;';
    
    var restoreBtn = document.createElement('button');
    restoreBtn.type = 'button';
    restoreBtn.style.cssText = 'flex:1;padding:14px;background:#2E7D32;color:white;border:none;border-radius:8px;font-weight:500;cursor:pointer;';
    restoreBtn.textContent = 'å¾©å…ƒã™ã‚‹';
    restoreBtn.onclick = function() {
      var text = textarea.value.trim();
      if (!text) {
        alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
        return;
      }
      restoreBackup(text, modal);
    };
    
    var cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.style.cssText = 'flex:1;padding:14px;background:#E8E4DB;color:#333;border:none;border-radius:8px;font-weight:500;cursor:pointer;';
    cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    cancelBtn.onclick = function() { modal.remove(); };
    
    btnContainer.appendChild(restoreBtn);
    btnContainer.appendChild(cancelBtn);
    
    inner.appendChild(title);
    inner.appendChild(desc);
    inner.appendChild(textarea);
    inner.appendChild(btnContainer);
    modal.appendChild(inner);
    document.body.appendChild(modal);
    
    textarea.focus();
  }

  function restoreBackup(text, modal) {
    try {
      var cleanText = text.trim();
      cleanText = cleanText.replace(/[\u201C\u201D]/g, '"');
      cleanText = cleanText.replace(/[\u2018\u2019]/g, "'");
      
      if (cleanText.charCodeAt(0) === 0xFEFF) {
        cleanText = cleanText.slice(1);
      }
      
      var backup = JSON.parse(cleanText);

      if (!backup.shifts && !backup.items) {
        alert('ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã§ã™');
        return;
      }

      state.shifts = backup.shifts || [];
      state.items = backup.items || {};
      state.history = backup.history || [];
      state.todayChecks = backup.todayChecks || {};

      saveToStorage(STORAGE_KEYS.shifts, state.shifts);
      saveToStorage(STORAGE_KEYS.items, state.items);
      saveToStorage(STORAGE_KEYS.history, state.history);
      saveToStorage(STORAGE_KEYS.todayChecks, state.todayChecks);

      state.editingShift = state.shifts.length > 0 ? state.shifts[0].id : null;

      renderShiftButtons();
      renderEditShiftTabs();
      renderEditList();
      renderHistory();
      
      if (state.currentShift) {
        renderChecklist();
        updateProgress();
        updateCompletedState();
      }

      modal.remove();
      alert('å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸï¼');

    } catch (e) {
      console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
      alert('ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\nã‚³ãƒ”ãƒ¼ã—ç›´ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  }

  function resetHistory() {
    var modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px;';
    
    var inner = document.createElement('div');
    inner.style.cssText = 'background:white;border-radius:12px;padding:24px;width:100%;max-width:320px;text-align:center;';
    
    var title = document.createElement('h3');
    title.style.cssText = 'margin-bottom:12px;color:#C53030;';
    title.textContent = 'âš ï¸ å±¥æ­´ã‚’å‰Šé™¤';
    
    var msg = document.createElement('p');
    msg.style.cssText = 'font-size:0.9rem;color:#666;margin-bottom:20px;';
    msg.textContent = 'ã™ã¹ã¦ã®å±¥æ­´ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚';
    
    var btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display:flex;gap:12px;';
    
    var cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.style.cssText = 'flex:1;padding:14px;background:#E8E4DB;color:#333;border:none;border-radius:8px;font-weight:500;cursor:pointer;';
    cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    cancelBtn.onclick = function() { modal.remove(); };
    
    var confirmBtn = document.createElement('button');
    confirmBtn.type = 'button';
    confirmBtn.style.cssText = 'flex:1;padding:14px;background:#C53030;color:white;border:none;border-radius:8px;font-weight:500;cursor:pointer;';
    confirmBtn.textContent = 'å‰Šé™¤ã™ã‚‹';
    confirmBtn.onclick = function() {
      state.history = [];
      saveToStorage(STORAGE_KEYS.history, state.history);
      renderHistory();
      updateCompletedState();
      modal.remove();
      
      var notification = document.createElement('div');
      notification.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:12px 24px;border-radius:8px;z-index:1000;font-weight:500;';
      notification.textContent = 'å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ';
      document.body.appendChild(notification);
      setTimeout(function() { notification.remove(); }, 2000);
    };
    
    btnContainer.appendChild(cancelBtn);
    btnContainer.appendChild(confirmBtn);
    inner.appendChild(title);
    inner.appendChild(msg);
    inner.appendChild(btnContainer);
    modal.appendChild(inner);
    document.body.appendChild(modal);
  }

  function selectShift(shiftId) {
    state.currentShift = shiftId;
    state.editingShift = shiftId;
    saveToStorage(STORAGE_KEYS.currentShift, shiftId);

    var shift = getShiftById(shiftId);
    document.getElementById('currentShiftName').textContent = shift ? shift.name : '';
    document.getElementById('currentShiftTime').textContent = shift ? getShiftTimeString(shift) : '';
    
    document.getElementById('shiftSelectScreen').style.display = 'none';
    document.getElementById('mainScreen').classList.add('active');

    renderChecklist();
    renderEditShiftTabs();
    renderEditList();
    updateProgress();
    updateCompletedState();
  }

  function changeShift() {
    document.getElementById('shiftSelectScreen').style.display = 'block';
    document.getElementById('mainScreen').classList.remove('active');
  }

  function setupTabs() {
    var tabs = document.querySelectorAll('.tab');
    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        var tabName = this.getAttribute('data-tab');

        tabs.forEach(function(t) {
          t.classList.remove('active');
        });
        this.classList.add('active');

        document.querySelectorAll('.panel').forEach(function(panel) {
          panel.classList.remove('active');
        });
        document.getElementById(tabName + 'Panel').classList.add('active');
      });
    });
  }

  function setupEventListeners() {
    document.getElementById('addShiftBtn').addEventListener('click', function() {
      openShiftModal();
    });

    document.getElementById('manageShiftsBtn').addEventListener('click', function() {
      renderShiftManageList();
      document.getElementById('manageShiftsModal').classList.add('show');
    });

    document.getElementById('shiftModalCancel').addEventListener('click', closeShiftModal);
    document.getElementById('shiftModalConfirm').addEventListener('click', saveShift);

    document.getElementById('manageShiftsClose').addEventListener('click', function() {
      document.getElementById('manageShiftsModal').classList.remove('show');
    });

    document.getElementById('deleteConfirmCancel').addEventListener('click', closeDeleteConfirmModal);
    document.getElementById('deleteConfirmOk').addEventListener('click', deleteShift);

    document.getElementById('changeShiftBtn').addEventListener('click', changeShift);

    document.getElementById('undoCompleteBtn').addEventListener('click', undoComplete);

    document.getElementById('completeBtn').addEventListener('click', completeCheck);

    document.getElementById('addItemBtn').addEventListener('click', addItem);

    document.getElementById('editModalCancel').addEventListener('click', closeEditModal);
    document.getElementById('editModalConfirm').addEventListener('click', confirmEdit);

    document.getElementById('exportBackupBtn').addEventListener('click', exportBackup);
    document.getElementById('showRestoreBtn').addEventListener('click', showRestoreModal);
    document.getElementById('resetHistoryBtn').addEventListener('click', resetHistory);

    setupTabs();

    setupDaySelectLogic('newItemDays');

    document.addEventListener('visibilitychange', function() {
      if (!document.hidden && checkDateChange()) {
        renderChecklist();
        updateProgress();
        updateCompletedState();
      }
    });
  }

  function init() {
    state.shifts = loadFromStorage(STORAGE_KEYS.shifts, []);
    state.items = loadFromStorage(STORAGE_KEYS.items, {});
    state.todayChecks = loadFromStorage(STORAGE_KEYS.todayChecks, {});
    state.history = loadFromStorage(STORAGE_KEYS.history, []);
    state.currentShift = loadFromStorage(STORAGE_KEYS.currentShift, null);
    state.editingShift = state.shifts.length > 0 ? state.shifts[0].id : null;

    if (checkDateChange()) {
      state.todayChecks = {};
    }

    document.getElementById('dateDisplay').textContent = getTodayString();

    renderShiftButtons();

    if (state.currentShift && getShiftById(state.currentShift)) {
      var shift = getShiftById(state.currentShift);
      document.getElementById('currentShiftName').textContent = shift.name;
      document.getElementById('currentShiftTime').textContent = getShiftTimeString(shift);
      document.getElementById('shiftSelectScreen').style.display = 'none';
      document.getElementById('mainScreen').classList.add('active');
      state.editingShift = state.currentShift;
    }

    renderChecklist();
    renderEditShiftTabs();
    renderEditList();
    renderHistory();
    updateProgress();
    updateCompletedState();
    setupEventListeners();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>

</body>
</html>
