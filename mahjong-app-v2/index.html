<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€æˆç¸¾ç®¡ç†</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', sans-serif; background: #f5f5f5; color: #333; padding: 12px; max-width: 500px; margin: 0 auto; }
        h1 { text-align: center; color: #1a5f3c; font-size: 1.4rem; margin-bottom: 6px; border-bottom: 2px solid #d4af37; padding-bottom: 6px; }
        .date { text-align: center; color: #888; font-size: 0.85rem; margin-bottom: 12px; }
        .rules { background: #1a5f3c; color: white; padding: 10px 12px; border-radius: 8px; margin-bottom: 12px; font-size: 0.8rem; }
        .rules b { color: #d4af37; }
        .card { background: white; border-radius: 10px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .card h2 { font-size: 1rem; color: #1a5f3c; margin-bottom: 10px; }

```
    /* å…¥åŠ›è¡Œ */
    .input-row { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
    .input-row .player-name { width: 65px; font-weight: bold; font-size: 0.9rem; }
    .input-row input {
        flex: 1;
        padding: 10px;
        font-size: 1rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        text-align: right;
        min-width: 0;
    }
    .input-row input.text-input {
        text-align: left;
    }
    .input-row input:focus { outline: none; border-color: #1a5f3c; }
    .input-row .unit { color: #888; font-size: 0.8rem; width: 20px; }
    .input-row label { width: 100px; font-weight: bold; font-size: 0.85rem; }
    
    /* Â±ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ - 2ã¤ã®ãƒœã‚¿ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ */
    .toggle-wrap {
        position: relative;
        width: 44px;
        height: 40px;
        flex-shrink: 0;
    }
    .toggle-btn {
        position: absolute;
        top: 0;
        left: 0;
        width: 44px;
        height: 40px;
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        font-size: 1.4rem;
        cursor: pointer;
        line-height: 40px;
        text-align: center;
    }
    .toggle-plus {
        background: #27ae60;
    }
    .toggle-minus {
        background: #c0392b;
    }
    .toggle-btn.hidden {
        visibility: hidden;
    }
    
    .error { color: #c0392b; font-size: 0.8rem; margin: 6px 0; display: none; }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn { display: inline-block; padding: 14px 20px; font-size: 1rem; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; }
    .btn-full { display: block; width: 100%; }
    .btn-green { background: #1a5f3c; color: white; }
    .btn-yellow { background: #d4af37; color: #333; }
    .btn-gray { background: #6c757d; color: white; }
    .btn-red { background: #c0392b; color: white; }
    .btn-outline { background: white; border: 2px solid #1a5f3c; color: #1a5f3c; }
    .btn-small { padding: 8px 12px; font-size: 0.85rem; }
    .btn-row { display: flex; gap: 10px; margin-top: 12px; }
    .btn-row .btn { flex: 1; }
    
    /* æ®‹ã‚Šè¨ˆç®—ãƒœã‚¿ãƒ³ */
    .calc-btn-row { margin-bottom: 10px; }
    .calc-btn-row .btn { padding: 10px; font-size: 0.9rem; }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 8px; }
    th, td { padding: 8px 4px; text-align: center; border: 1px solid #ddd; }
    th { background: #1a5f3c; color: white; }
    .positive { color: #27ae60; font-weight: bold; }
    .negative { color: #c0392b; font-weight: bold; }
    .top-row { background: #fffbe6; }
    
    /* å±¥æ­´ */
    .game-item { background: #fafafa; border-left: 3px solid #1a5f3c; padding: 10px; margin-bottom: 10px; }
    .game-header { font-weight: bold; color: #1a5f3c; margin-bottom: 8px; }
    
    /* ä¿®æ­£å‰Šé™¤ã‚«ãƒ¼ãƒ‰ */
    .action-card { background: #fff3cd; border: 2px solid #d4af37; }
    .action-card .input-row select { flex: 1; padding: 10px; font-size: 1rem; border: 2px solid #ddd; border-radius: 6px; }
    
    /* è¨­å®šã‚«ãƒ¼ãƒ‰ */
    .settings-card { background: #e8f5e9; border: 2px solid #1a5f3c; }
    .settings-card h2 { display: flex; justify-content: space-between; align-items: center; }
    .settings-content { display: none; }
    .settings-content.show { display: block; }
    .settings-section { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #ccc; }
    .settings-section:last-child { margin-bottom: 0; border-bottom: none; }
    .settings-section h3 { font-size: 0.9rem; color: #1a5f3c; margin-bottom: 8px; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-bg { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; padding: 16px; }
    .modal-bg.show { display: flex; }
    .modal { background: white; border-radius: 10px; padding: 16px; width: 100%; max-width: 350px; max-height: 90vh; overflow-y: auto; }
    .modal h3 { color: #1a5f3c; margin-bottom: 12px; }
    
    .no-print { }
    @media print { .no-print { display: none !important; } }
</style>
```

</head>
<body>

<div id="mainArea">
    <h1>ğŸ€„ éº»é›€æˆç¸¾ç®¡ç†</h1>
    <div class="date" id="dateArea"></div>

```
<div class="rules" id="rulesDisplay"></div>

<!-- è¨­å®šã‚«ãƒ¼ãƒ‰ -->
<div class="card settings-card no-print">
    <h2>
        âš™ï¸ è¨­å®š
        <button class="btn btn-outline btn-small" id="btnToggleSettings">é–‹ã</button>
    </h2>
    <div class="settings-content" id="settingsContent">
        <div class="settings-section">
            <h3>ğŸ‘¥ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</h3>
            <div class="input-row">
                <label>1äººç›®</label>
                <input type="text" id="playerName0" class="text-input" placeholder="åå‰">
            </div>
            <div class="input-row">
                <label>2äººç›®</label>
                <input type="text" id="playerName1" class="text-input" placeholder="åå‰">
            </div>
            <div class="input-row">
                <label>3äººç›®</label>
                <input type="text" id="playerName2" class="text-input" placeholder="åå‰">
            </div>
            <div class="input-row">
                <label>4äººç›®</label>
                <input type="text" id="playerName3" class="text-input" placeholder="åå‰">
            </div>
        </div>
        <div class="settings-section">
            <h3>ğŸ“‹ ãƒ«ãƒ¼ãƒ«è¨­å®š</h3>
            <div class="input-row">
                <label>è¿”ã—ç‚¹</label>
                <input type="tel" id="ruleReturn" placeholder="30000">
                <span class="unit">ç‚¹</span>
            </div>
            <div class="input-row">
                <label>ã‚¦ãƒï¼ˆ1-4ä½ï¼‰</label>
                <input type="text" id="ruleUma" class="text-input" placeholder="20,10,-10,-20">
            </div>
            <div class="input-row">
                <label>ã‚ªã‚«ï¼ˆ1-4ä½ï¼‰</label>
                <input type="text" id="ruleOka" class="text-input" placeholder="15,5,0,0">
            </div>
            <div class="input-row">
                <label>ãƒ¬ãƒ¼ãƒˆ</label>
                <input type="tel" id="ruleRate" placeholder="50">
                <span class="unit">å††</span>
            </div>
        </div>
        <button class="btn btn-green btn-full" id="btnSaveSettings">è¨­å®šã‚’ä¿å­˜</button>
        <p style="font-size:0.75rem; color:#888; margin-top:8px; text-align:center;">â€»è¨­å®šã‚’ä¿å­˜ã™ã‚‹ã¨å¯¾å±€å±¥æ­´ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</p>
    </div>
</div>

<div class="card no-print">
    <h2>ğŸ¯ å¯¾å±€çµæœå…¥åŠ›</h2>
    <div id="inputArea"></div>
    <div class="calc-btn-row">
        <button class="btn btn-outline btn-full" id="btnCalcLast">ğŸ”¢ æ®‹ã‚Š1äººã‚’è‡ªå‹•è¨ˆç®—</button>
    </div>
    <div class="error" id="errorMsg"></div>
    <button class="btn btn-green btn-full" id="btnRecord">è¨˜éŒ²ã™ã‚‹</button>
</div>

<!-- ä¿®æ­£ãƒ»å‰Šé™¤ç”¨ã®ã‚«ãƒ¼ãƒ‰ -->
<div class="card action-card no-print" id="actionCard" style="display:none;">
    <h2>âœï¸ å¯¾å±€ã®ä¿®æ­£ãƒ»å‰Šé™¤</h2>
    <div class="input-row">
        <span class="player-name">å¯¾è±¡</span>
        <select id="targetGame"></select>
    </div>
    <div class="btn-row">
        <button class="btn btn-gray" id="btnEdit">ä¿®æ­£</button>
        <button class="btn btn-red" id="btnDelete">å‰Šé™¤</button>
    </div>
</div>

<div class="card" id="totalCard" style="display:none;">
    <h2>ğŸ“Š ãƒˆãƒ¼ã‚¿ãƒ«æˆç¸¾</h2>
    <div id="totalArea"></div>
</div>

<div class="card" id="historyCard" style="display:none;">
    <h2>ğŸ“ å¯¾å±€å±¥æ­´</h2>
    <div id="historyArea"></div>
</div>
```

</div>

<div class="btn-row no-print" id="actionBtns" style="display:none;">
    <button class="btn btn-yellow btn-full" id="btnCopy">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
</div>

<div class="modal-bg" id="editModal">
    <div class="modal">
        <h3>ğŸ“ ç¬¬<span id="editNum"></span>å›æˆ¦ã‚’ä¿®æ­£</h3>
        <div id="editInputArea"></div>
        <div class="calc-btn-row">
            <button class="btn btn-outline btn-full" id="btnCalcLastEdit">ğŸ”¢ æ®‹ã‚Š1äººã‚’è‡ªå‹•è¨ˆç®—</button>
        </div>
        <div class="error" id="editErrorMsg"></div>
        <div class="btn-row">
            <button class="btn btn-gray" id="btnCancelEdit">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-green" id="btnSaveEdit">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
const DEFAULT_PLAYERS = ['ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1', 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2', 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3', 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4'];
const DEFAULT_RULES = { returnPoint: 30000, uma: [20, 10, -10, -20], oka: [15, 5, 0, 0], rate: 50 };

// ç¾åœ¨ã®è¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿ or ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
let PLAYERS = [...DEFAULT_PLAYERS];
let RULES = { ...DEFAULT_RULES };
const TOTAL_POINTS = 100000;

let games = [];
let totals = {};
let editingGameNumber = null;

// ========================================
// åˆæœŸåŒ–
// ========================================
function init() {
    document.getElementById('dateArea').textContent = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

    // è¨­å®šã‚’èª­ã¿è¾¼ã¿
    loadSettings();
    
    // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆ
    document.getElementById('inputArea').innerHTML = createInputRowsHTML('inp');
    
    // totalsåˆæœŸåŒ–
    PLAYERS.forEach(p => totals[p] = 0);

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    document.getElementById('btnRecord').addEventListener('click', recordGame);
    document.getElementById('btnCalcLast').addEventListener('click', () => calcLastPlayer('inp'));
    document.getElementById('btnEdit').addEventListener('click', openEditModal);
    document.getElementById('btnDelete').addEventListener('click', doDelete);
    document.getElementById('btnCopy').addEventListener('click', copyResult);
    document.getElementById('btnCancelEdit').addEventListener('click', closeModal);
    document.getElementById('btnSaveEdit').addEventListener('click', saveEdit);
    document.getElementById('btnCalcLastEdit').addEventListener('click', () => calcLastPlayer('editInp'));
    document.getElementById('btnToggleSettings').addEventListener('click', toggleSettings);
    document.getElementById('btnSaveSettings').addEventListener('click', saveSettings);
    
    document.getElementById('editModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('editModal')) closeModal();
    });

    // Â±ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    setupToggleButtons('inp');

    // ãƒ«ãƒ¼ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
    updateRulesDisplay();
    
    // è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’è¡¨ç¤º
    populateSettingsForm();

    loadData();
}

// ========================================
// è¨­å®šã®é–‹é–‰
// ========================================
function toggleSettings() {
    const content = document.getElementById('settingsContent');
    const btn = document.getElementById('btnToggleSettings');
    content.classList.toggle('show');
    btn.textContent = content.classList.contains('show') ? 'é–‰ã˜ã‚‹' : 'é–‹ã';
}

// ========================================
// è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’å…¥ã‚Œã‚‹
// ========================================
function populateSettingsForm() {
    for (let i = 0; i < 4; i++) {
        document.getElementById(`playerName${i}`).value = PLAYERS[i] || '';
    }
    document.getElementById('ruleReturn').value = RULES.returnPoint;
    document.getElementById('ruleUma').value = RULES.uma.join(',');
    document.getElementById('ruleOka').value = RULES.oka.join(',');
    document.getElementById('ruleRate').value = RULES.rate;
}

// ========================================
// ãƒ«ãƒ¼ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
// ========================================
function updateRulesDisplay() {
    const umaStr = `${RULES.uma[0]}-${Math.abs(RULES.uma[3])}`;
    const okaStr = RULES.oka[0] > 0 ? `ã‚ªã‚«${RULES.oka[0]}ã¨${RULES.oka[1]}` : 'ã‚ªã‚«ãªã—';
    document.getElementById('rulesDisplay').innerHTML = 
        `<b>ğŸ“‹ ãƒ«ãƒ¼ãƒ«:</b> ${RULES.returnPoint/10000}ä¸‡ç‚¹è¿”ã— / ã‚¦ãƒ${umaStr} / ${okaStr} / ç‚¹${RULES.rate/10}`;
}

// ========================================
// è¨­å®šã‚’ä¿å­˜
// ========================================
function saveSettings() {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å–å¾—
    const newPlayers = [];
    for (let i = 0; i < 4; i++) {
        const name = document.getElementById(`playerName${i}`).value.trim();
        newPlayers.push(name || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i + 1}`);
    }
    
    // ãƒ«ãƒ¼ãƒ«ã‚’å–å¾—
    const returnPoint = parseInt(document.getElementById('ruleReturn').value) || 30000;
    const umaStr = document.getElementById('ruleUma').value;
    const okaStr = document.getElementById('ruleOka').value;
    const rate = parseInt(document.getElementById('ruleRate').value) || 50;
    
    // ã‚¦ãƒã‚’ãƒ‘ãƒ¼ã‚¹
    let uma = [20, 10, -10, -20];
    if (umaStr) {
        const parts = umaStr.split(',').map(s => parseInt(s.trim()));
        if (parts.length === 4 && parts.every(n => !isNaN(n))) {
            uma = parts;
        }
    }
    
    // ã‚ªã‚«ã‚’ãƒ‘ãƒ¼ã‚¹
    let oka = [15, 5, 0, 0];
    if (okaStr) {
        const parts = okaStr.split(',').map(s => parseInt(s.trim()));
        if (parts.length === 4 && parts.every(n => !isNaN(n))) {
            oka = parts;
        }
    }
    
    // è¨­å®šã‚’æ›´æ–°
    PLAYERS = newPlayers;
    RULES = { returnPoint, uma, oka, rate };
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('mahjongSettings', JSON.stringify({ players: PLAYERS, rules: RULES }));
    
    // å¯¾å±€å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
    games = [];
    PLAYERS.forEach(p => totals[p] = 0);
    localStorage.removeItem('mahjongGames');
    
    // UIã‚’æ›´æ–°
    document.getElementById('inputArea').innerHTML = createInputRowsHTML('inp');
    setupToggleButtons('inp');
    updateRulesDisplay();
    render();
    
    // è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
    toggleSettings();
    
    alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
}

// ========================================
// è¨­å®šã‚’èª­ã¿è¾¼ã¿
// ========================================
function loadSettings() {
    const saved = localStorage.getItem('mahjongSettings');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            if (data.players && data.players.length === 4) {
                PLAYERS = data.players;
            }
            if (data.rules) {
                RULES = { ...DEFAULT_RULES, ...data.rules };
            }
        } catch (e) {
            console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        }
    }
}

// ========================================
// å…¥åŠ›è¡ŒHTMLç”Ÿæˆ
// ========================================
function createInputRowsHTML(prefix) {
    return PLAYERS.map((player, i) => `
        <div class="input-row">
            <span class="player-name">${player}</span>
            <div class="toggle-wrap">
                <button type="button" class="toggle-btn toggle-plus" id="${prefix}Plus${i}">ï¼‹</button>
                <button type="button" class="toggle-btn toggle-minus hidden" id="${prefix}Minus${i}">ãƒ¼</button>
            </div>
            <input type="tel" id="${prefix}${i}" placeholder="25000">
            <span class="unit">ç‚¹</span>
        </div>
    `).join('');
}

// ========================================
// Â±ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®è¨­å®šï¼ˆ2ãƒœã‚¿ãƒ³æ–¹å¼ï¼‰
// ========================================
function setupToggleButtons(prefix) {
    PLAYERS.forEach((_, i) => {
        const plusBtn = document.getElementById(`${prefix}Plus${i}`);
        const minusBtn = document.getElementById(`${prefix}Minus${i}`);
        if (plusBtn) {
            plusBtn.addEventListener('click', () => toggleToMinus(prefix, i));
        }
        if (minusBtn) {
            minusBtn.addEventListener('click', () => toggleToPlus(prefix, i));
        }
    });
}

function toggleToMinus(prefix, index) {
    const plusBtn = document.getElementById(`${prefix}Plus${index}`);
    const minusBtn = document.getElementById(`${prefix}Minus${index}`);
    plusBtn.classList.add('hidden');
    minusBtn.classList.remove('hidden');
}

function toggleToPlus(prefix, index) {
    const plusBtn = document.getElementById(`${prefix}Plus${index}`);
    const minusBtn = document.getElementById(`${prefix}Minus${index}`);
    plusBtn.classList.remove('hidden');
    minusBtn.classList.add('hidden');
}

function isNegativeMode(prefix, index) {
    const minusBtn = document.getElementById(`${prefix}Minus${index}`);
    return minusBtn && !minusBtn.classList.contains('hidden');
}

function setNegativeMode(prefix, index, negative) {
    if (negative) {
        toggleToMinus(prefix, index);
    } else {
        toggleToPlus(prefix, index);
    }
}

// ========================================
// æ®‹ã‚Š1äººè‡ªå‹•è¨ˆç®—
// ========================================
function calcLastPlayer(prefix) {
    const values = [];
    let emptyIndex = -1;
    let emptyCount = 0;
    
    PLAYERS.forEach((_, i) => {
        const input = document.getElementById(`${prefix}${i}`);
        let val = parsePoint(input.value);
        
        if (isNaN(val) || input.value.trim() === '') {
            emptyCount++;
            emptyIndex = i;
            values.push(null);
        } else {
            // Â±ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’åæ˜ 
            if (isNegativeMode(prefix, i)) {
                val = -Math.abs(val);
            }
            values.push(val);
        }
    });
    
    if (emptyCount !== 1) {
        alert('3äººã®ç‚¹æ•°ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰æŠ¼ã—ã¦ãã ã•ã„');
        return;
    }
    
    const sum = values.filter(v => v !== null).reduce((a, b) => a + b, 0);
    const lastValue = TOTAL_POINTS - sum;
    
    const input = document.getElementById(`${prefix}${emptyIndex}`);
    
    input.value = Math.abs(lastValue);
    setNegativeMode(prefix, emptyIndex, lastValue < 0);
}

// ========================================
// ç‚¹æ•°ãƒ‘ãƒ¼ã‚¹ï¼ˆå…¨è§’å¯¾å¿œãƒ»ç¬¦å·å¯¾å¿œï¼‰
// ========================================
function parsePoint(val) {
    if (val === '' || val === null || val === undefined) return NaN;
    const s = String(val).replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
        .replace(/ãƒ¼|âˆ’/g, '-').replace(/,/g, '').trim();
    return parseInt(s, 10);
}

// ========================================
// å…¥åŠ›å€¤å–å¾—ï¼ˆÂ±ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’åæ˜ ï¼‰
// ========================================
function getInputPoints(prefix) {
    const pts = [];
    for (let i = 0; i < PLAYERS.length; i++) {
        const input = document.getElementById(`${prefix}${i}`);
        let val = parsePoint(input.value);
        
        if (isNaN(val)) {
            return { error: `${PLAYERS[i]}ã®ç‚¹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`, points: null };
        }
        
        // Â±ãƒœã‚¿ãƒ³ãŒãƒã‚¤ãƒŠã‚¹çŠ¶æ…‹ãªã‚‰è² ã«å¤‰æ›
        if (isNegativeMode(prefix, i)) {
            val = -Math.abs(val);
        } else {
            val = Math.abs(val);
        }
        
        pts.push(val);
    }
    return { error: null, points: pts };
}

// ========================================
// ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆã‚¼ãƒ­ã‚µãƒ ä¿è¨¼ãƒ»åŒç‚¹ã¯ä¸Šå®¶å„ªå…ˆï¼‰
// ========================================
function calcScores(points) {
    const arr = PLAYERS.map((player, i) => ({ player, points: points[i], idx: i }));
    arr.sort((a, b) => b.points !== a.points ? b.points - a.points : a.idx - b.idx);

    const scores = {};
    arr.forEach((item, rank) => {
        const sc = (item.points - RULES.returnPoint) / 1000 + RULES.uma[rank] + RULES.oka[rank];
        scores[item.player] = Math.round(sc * 10) / 10;
    });

    // ã‚¼ãƒ­ã‚µãƒ èª¿æ•´
    let sum = Object.values(scores).reduce((a, b) => a + b, 0);
    sum = Math.round(sum * 10) / 10;
    if (sum !== 0) {
        scores[arr[0].player] = Math.round((scores[arr[0].player] - sum) * 10) / 10;
    }

    return { scores, ranked: arr.map(x => x.player) };
}

// ========================================
// ãƒˆãƒ¼ã‚¿ãƒ«å†è¨ˆç®—ï¼ˆgamesã‹ã‚‰æ¯å›è¨ˆç®—ï¼‰
// ========================================
function recalcTotals() {
    PLAYERS.forEach(p => totals[p] = 0);
    games.forEach(g => {
        for (const p in g.scores) {
            if (totals[p] !== undefined) {
                totals[p] += g.scores[p];
            }
        }
    });
    PLAYERS.forEach(p => totals[p] = Math.round(totals[p] * 10) / 10);
}

// ========================================
// å¯¾å±€è¨˜éŒ²
// ========================================
function recordGame() {
    const errEl = document.getElementById('errorMsg');
    errEl.style.display = 'none';

    const { error, points } = getInputPoints('inp');
    if (error) {
        errEl.textContent = error;
        errEl.style.display = 'block';
        return;
    }

    const total = points.reduce((a, b) => a + b, 0);
    if (total !== TOTAL_POINTS) {
        errEl.textContent = `åˆè¨ˆãŒ${total.toLocaleString()}ç‚¹ã§ã™ï¼ˆ10ä¸‡ç‚¹ã«ãªã‚‹ã‚ˆã†å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰`;
        errEl.style.display = 'block';
        return;
    }

    const result = calcScores(points);
    games.push({ 
        gameNumber: games.length + 1, 
        points: [...points], 
        scores: result.scores, 
        ranked: result.ranked 
    });
    
    recalcTotals();
    render();
    saveData();
    
    // å…¥åŠ›ã‚¯ãƒªã‚¢
    PLAYERS.forEach((_, i) => {
        document.getElementById(`inp${i}`).value = '';
        setNegativeMode('inp', i, false);
    });
}

// ========================================
// è¡¨ç¤ºæ›´æ–°
// ========================================
function render() {
    const tc = document.getElementById('totalCard');
    const hc = document.getElementById('historyCard');
    const ab = document.getElementById('actionBtns');
    const ac = document.getElementById('actionCard');
    
    if (games.length === 0) {
        tc.style.display = 'none';
        hc.style.display = 'none';
        ab.style.display = 'none';
        ac.style.display = 'none';
        return;
    }
    
    tc.style.display = 'block';
    hc.style.display = 'block';
    ab.style.display = 'flex';
    ac.style.display = 'block';

    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æ›´æ–°
    document.getElementById('targetGame').innerHTML = games.map(g => 
        `<option value="${g.gameNumber}">ç¬¬${g.gameNumber}å›æˆ¦</option>`
    ).join('');

    // ãƒˆãƒ¼ã‚¿ãƒ«æˆç¸¾
    const sorted = [...PLAYERS].sort((a, b) => totals[b] - totals[a]);
    let html = '<table><tr><th>é †ä½</th><th>åå‰</th><th>ã‚¹ã‚³ã‚¢</th><th>ç²¾ç®—é¡</th></tr>';
    sorted.forEach((p, i) => {
        const sc = totals[p];
        const money = Math.round(sc * RULES.rate);
        const cls = (i === 0 && sc > 0) ? 'top-row' : '';
        const scCls = sc >= 0 ? 'positive' : 'negative';
        html += `<tr class="${cls}"><td>${i + 1}ä½</td><td>${i === 0 && sc > 0 ? 'ğŸ‘‘ ' : ''}${p}</td>`;
        html += `<td class="${scCls}">${sc >= 0 ? '+' : ''}${sc.toFixed(1)}</td>`;
        html += `<td class="${scCls}">${money >= 0 ? '+' : ''}${money.toLocaleString()}å††</td></tr>`;
    });
    document.getElementById('totalArea').innerHTML = html + '</table>';

    // å±¥æ­´
    let hHtml = '';
    for (let i = games.length - 1; i >= 0; i--) {
        const g = games[i];
        hHtml += `<div class="game-item"><div class="game-header">ç¬¬${g.gameNumber}å›æˆ¦</div>`;
        hHtml += '<table><tr><th>é †ä½</th><th>åå‰</th><th>æŒã¡ç‚¹</th><th>ã‚¹ã‚³ã‚¢</th></tr>';
        g.ranked.forEach((pl, r) => {
            const pi = PLAYERS.indexOf(pl);
            const pt = g.points[pi];
            const sc = g.scores[pl];
            hHtml += `<tr><td>${r + 1}ä½</td><td>${pl}</td><td>${pt.toLocaleString()}ç‚¹</td>`;
            hHtml += `<td class="${sc >= 0 ? 'positive' : 'negative'}">${sc >= 0 ? '+' : ''}${sc.toFixed(1)}</td></tr>`;
        });
        hHtml += '</table></div>';
    }
    document.getElementById('historyArea').innerHTML = hHtml;
}

// ========================================
// ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ«
// ========================================
function openEditModal() {
    const gn = parseInt(document.getElementById('targetGame').value, 10);
    if (isNaN(gn)) { alert('å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    
    editingGameNumber = gn;
    const g = games.find(game => game.gameNumber === gn);
    if (!g) return;
    
    document.getElementById('editNum').textContent = gn;
    document.getElementById('editInputArea').innerHTML = createInputRowsHTML('editInp');
    
    // Â±ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆå…ˆã«è¨­å®šï¼‰
    setupToggleButtons('editInp');
    
    // å€¤ã‚’è¨­å®š
    PLAYERS.forEach((_, i) => {
        const input = document.getElementById(`editInp${i}`);
        const val = g.points[i];
        input.value = Math.abs(val);
        setNegativeMode('editInp', i, val < 0);
    });
    
    document.getElementById('editErrorMsg').style.display = 'none';
    document.getElementById('editModal').classList.add('show');
}

function closeModal() {
    editingGameNumber = null;
    document.getElementById('editModal').classList.remove('show');
}

function saveEdit() {
    if (editingGameNumber === null) return;
    
    const errEl = document.getElementById('editErrorMsg');
    errEl.style.display = 'none';

    const { error, points } = getInputPoints('editInp');
    if (error) {
        errEl.textContent = error;
        errEl.style.display = 'block';
        return;
    }

    const total = points.reduce((a, b) => a + b, 0);
    if (total !== TOTAL_POINTS) {
        errEl.textContent = `åˆè¨ˆãŒ${total.toLocaleString()}ç‚¹ã§ã™ï¼ˆ10ä¸‡ç‚¹ã«ãªã‚‹ã‚ˆã†å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰`;
        errEl.style.display = 'block';
        return;
    }

    const result = calcScores(points);
    const game = games.find(g => g.gameNumber === editingGameNumber);
    if (game) {
        game.points = [...points];
        game.scores = result.scores;
        game.ranked = result.ranked;
    }
    
    recalcTotals();
    render();
    saveData();
    closeModal();
}

// ========================================
// å‰Šé™¤ï¼ˆconfirmãªã—ï¼‰
// ========================================
function doDelete() {
    const selectEl = document.getElementById('targetGame');
    const gn = parseInt(selectEl.value, 10);
    
    if (isNaN(gn) || games.length === 0) { 
        alert('å‰Šé™¤ã™ã‚‹å¯¾å±€ãŒã‚ã‚Šã¾ã›ã‚“'); 
        return; 
    }
    
    games = games.filter(g => g.gameNumber !== gn);
    games.forEach((g, i) => g.gameNumber = i + 1);
    
    recalcTotals();
    render();
    saveData();
    
    alert(`ç¬¬${gn}å›æˆ¦ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
}

// ========================================
// çµæœã‚³ãƒ”ãƒ¼
// ========================================
function copyResult() {
    const today = new Date();
    const dateStr = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
    
    const umaStr = `${RULES.uma[0]}-${Math.abs(RULES.uma[3])}`;
    const okaStr = RULES.oka[0] > 0 ? `ã‚ªã‚«${RULES.oka[0]}ã¨${RULES.oka[1]}` : 'ã‚ªã‚«ãªã—';
    
    let text = `ğŸ€„ éº»é›€æˆç¸¾ ${dateStr}\n`;
    text += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    
    text += 'ã€ãƒˆãƒ¼ã‚¿ãƒ«æˆç¸¾ã€‘\n';
    const sorted = [...PLAYERS].sort((a, b) => totals[b] - totals[a]);
    sorted.forEach((p, i) => {
        const sc = totals[p];
        const money = Math.round(sc * RULES.rate);
        const crown = (i === 0 && sc > 0) ? 'ğŸ‘‘' : 'ã€€';
        text += `${crown}${i + 1}ä½ ${p}ï¼š${sc >= 0 ? '+' : ''}${sc.toFixed(1)}ptï¼ˆ${money >= 0 ? '+' : ''}${money}å††ï¼‰\n`;
    });
    
    text += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    
    games.forEach(game => {
        text += `ã€ç¬¬${game.gameNumber}å›æˆ¦ã€‘\n`;
        game.ranked.forEach((pl, r) => {
            const pi = PLAYERS.indexOf(pl);
            const pt = game.points[pi];
            const sc = game.scores[pl];
            text += `${r + 1}ä½ ${pl}ï¼š${pt.toLocaleString()}ç‚¹ï¼ˆ${sc >= 0 ? '+' : ''}${sc.toFixed(1)}ï¼‰\n`;
        });
        text += '\n';
    });
    
    text += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
    text += `ãƒ«ãƒ¼ãƒ«ï¼š${RULES.returnPoint/10000}ä¸‡ç‚¹è¿”ã—/ã‚¦ãƒ${umaStr}/${okaStr}/ç‚¹${RULES.rate/10}\n`;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nLINEã‚„ãƒ¡ãƒ¢å¸³ã«è²¼ã‚Šä»˜ã‘ã§ãã¾ã™');
        }).catch(() => fallbackCopy(text));
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.left = '-9999px';
    document.body.appendChild(textarea);
    textarea.select();
    try {
        document.execCommand('copy');
        alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nLINEã‚„ãƒ¡ãƒ¢å¸³ã«è²¼ã‚Šä»˜ã‘ã§ãã¾ã™');
    } catch (e) {
        alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ');
    }
    document.body.removeChild(textarea);
}

// ========================================
// ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­è¾¼ï¼ˆgamesã®ã¿ä¿å­˜ï¼‰
// ========================================
function saveData() {
    localStorage.setItem('mahjongGames', JSON.stringify(games));
}

function loadData() {
    const saved = localStorage.getItem('mahjongGames');
    if (saved) {
        try {
            games = JSON.parse(saved) || [];
            recalcTotals();
            render();
        } catch (e) {
            console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        }
    }
}

// åˆæœŸåŒ–å®Ÿè¡Œ
init();
</script>

</body>
</html>
